{%- comment -%}
  ETHOSSENCE FEATURE: Allow customers to submit their cart for review/quote with ability to create an account if not a customer.
  BOTH forms are dynamically generated via Make webhook based on metaobject definitions.
{%- endcomment -%}

{{ 'ethossence-request-review.css' | asset_url | stylesheet_tag }}

{%- style -%}
  /* Section Padding - Requires Liquid variables */
  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
  }

  @media screen and (min-width: 750px) {
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    }
  }
{%- endstyle -%}

{%- if cart.item_count != 0 -%}

  <div class="color-{{ section.settings.color_scheme }} gradient {%if section.settings.full_width %}page-width {% endif %}section-{{ section.id }}-padding">
    <div class="frame {%if section.settings.full_width == false %} width-90{% endif %} text-{{ section.settings.content_alignment }}">

      {%- for block in section.blocks -%} 
        {%- case block.type -%}                            

          {%- when 'content' -%}
            {%- comment -%} CONTENT ADDED BY PAGE - UNCHANGED {%- endcomment -%}
            {%- liquid 
              assign selected_page = pages[block.settings.page]
              assign img_hero_class = selected_page.metafields.ethossence.img_hero_placement | prepend: 'img-' | replace: ' ', '-' | replace: '-|-', ' img-' | downcase | strip

              if block.settings.content_audience == 'visitors' and customer == null
                assign show_block = true
              elsif block.settings.content_audience == 'accounts' and customer != null
                assign show_block = true
              else
                assign show_block = false 
              endif
            -%}
            {%- if selected_page != null and show_block -%}
              {%- style -%}
                .block-{{ block.id }}-padding {
                    padding-top: {{ block.settings.padding_top | times: 0.75 | round: 0 }}px;
                    padding-bottom: {{ block.settings.padding_bottom | times: 0.75 | round: 0 }}px;
                }

                @media screen and (min-width: 750px) {
                    .block-{{ block.id }}-padding {
                      padding-top: {{ block.settings.padding_top }}px;
                      padding-bottom: {{ block.settings.padding_bottom }}px;
                    }
                }
              {%- endstyle -%}
              <div class="block-{{ block.id }}-padding">
                {%- if block.settings.heading_hide != true -%}
                  <{{ block.settings.heading_size }} class="page-title {{ block.settings.heading_size }}{% if settings.animations_reveal_on_scroll %} scroll-trigger animate--slide-in{% endif %}">
                    {{ selected_page.title | escape }}
                  </{{ block.settings.heading_size }}>
                {%- endif -%}
                {%- if selected_page.content != blank -%}
                  <div>
                    {%- if selected_page.metafields.ethossence.img_hero != blank -%}      
                      {{ selected_page.metafields.ethossence.img_hero | image_url: width: 600 | image_tag: loading: 'lazy', class: img_hero_class }}
                    {%- endif -%}          
                    {{ selected_page.content }}
                  </div>
                {%- endif -%}
              </div>
            {%- endif -%}


          {%- when 'form' -%}
            {%- comment -%} 
              DYNAMICALLY LOADED FORMS FOR BOTH GUESTS AND CUSTOMERS
              Forms are loaded via webhook when user clicks trigger button
            {%- endcomment -%}

            {%- assign s_animation_type = block.settings.animation_type | default: 'slide_down' -%}             

            {%- style -%}
              .block-{{ block.id }}-padding {
                  padding-top: {{ block.settings.padding_top | times: 0.75 | round: 0 }}px;
                  padding-bottom: {{ block.settings.padding_bottom | times: 0.75 | round: 0 }}px;
              }

              @media screen and (min-width: 750px) {
                  .block-{{ block.id }}-padding {
                    padding-top: {{ block.settings.padding_top }}px;
                    padding-bottom: {{ block.settings.padding_bottom }}px;
                  }
              }
            {%- endstyle -%}

            <div class="block-{{ block.id }}-padding text-{{ block.settings.content_alignment }}">     

              {%- if customer == null -%}
                
                {%- comment -%} GUEST USER - TRIGGER FOR ACCOUNT CREATION FORM {%- endcomment -%}
                <button type="button" id="review-form-trigger" class="button button--primary" 
                        data-is-customer="false"
                        data-customer-id=""
                        data-customer-email="">
                  {{ block.settings.btn_trigger_account_form | default: 'Create Account to Request Review' }}
                </button>
                
                <!-- LINK TO SIGN IN IF ALREADY HAVE AN ACCOUNT -->
                <div id="sign-in-link" class="margin-element-sm">
                  Already have an account? <a href="{{ routes.account_login_url }}?return_url={{ routes.cart_url | url_encode }}" title="Sign in to your existing account">sign in &raquo;</a>
                </div>

              {%- else -%}

                {%- comment -%} LOGGED IN CUSTOMER - TRIGGER FOR CART REVIEW FORM {%- endcomment -%}
                <button type="button" id="review-form-trigger" class="button button--primary"
                        data-is-customer="true"
                        data-customer-id="{{ customer.id }}"
                        data-customer-email="{{ customer.email }}">
                  {{ block.settings.btn_trigger_request_form | default: 'Start Review Request' }}
                </button>

              {%- endif -%}

              {%- comment -%} DYNAMIC FORM CONTAINER - WORKS FOR BOTH GUESTS AND CUSTOMERS {%- endcomment -%}
              {% if block.settings.animation_type == 'slide_down' %}
                <!-- SLIDE DOWN DROPDOWN -->
                <div id="review-form-dropdown" class="form-dropdown">
                  <div class="form-dropdown__content">              
                    <{{ block.settings.heading_size }} class="form-title {{ block.settings.heading_size }}{% if settings.animations_reveal_on_scroll %} scroll-trigger animate--slide-in{% endif %}" id="form-heading">
                      {%- if customer == null -%}
                        {{ block.settings.create_account_head_text }}
                      {%- else -%}
                        {{ block.settings.submit_cart_head_text }}
                      {%- endif -%}
                    </{{ block.settings.heading_size }}>
                    
                    <!-- DYNAMIC CONTENT CONTAINER -->
                    <div id="dynamic-content-container"
                         data-is-customer="{% if customer %}true{% else %}false{% endif %}"
                         data-customer-id="{% if customer %}{{ customer.id }}{% endif %}"
                         data-customer-email="{% if customer %}{{ customer.email }}{% endif %}">
                      <div class="loading-spinner">Loading form...</div>
                    </div>
                  </div>
                  <div> 
                    <button type="button" class="button button--small button--secondary dropdown__close float-right" id="close-form-dropdown" aria-label="Close form">Cancel</button>
                  </div>               
                </div>
              {% else %}
                <!-- SLIDE OUT DRAWER -->
                <div id="review-form-drawer" class="drawer drawer--right">
                  <div class="drawer__header">
                    <{{ block.settings.heading_size }} class="form-title {{ block.settings.heading_size }}" id="form-heading">
                      {%- if customer == null -%}
                        {{ block.settings.create_account_head_text }}
                      {%- else -%}
                        {{ block.settings.submit_cart_head_text }}
                      {%- endif -%}
                    </{{ block.settings.heading_size }}>                      
                    <button type="button" class="drawer__close" id="close-form-drawer" aria-label="Close form"><span class="text-xlarge">X</span></button>
                  </div>
                  <div class="drawer__inner">
                    <!-- DYNAMIC CONTENT CONTAINER -->
                    <div id="dynamic-content-container"
                         data-is-customer="{% if customer %}true{% else %}false{% endif %}"
                         data-customer-id="{% if customer %}{{ customer.id }}{% endif %}"
                         data-customer-email="{% if customer %}{{ customer.email }}{% endif %}">
                      <div class="loading-spinner">Loading form...</div>
                    </div>
                  </div>
                </div>
                <div class="drawer__overlay" id="review-form-overlay"></div>
              {% endif %}

            </div>

        {%- endcase -%}
      {%- endfor -%}      

    </div>
  </div>

  <!-- UNIFIED JAVASCRIPT FOR DYNAMIC FORM LOADING -->
  <script src="{{ 'ethossence-request-review.js' | asset_url }}" defer></script>
  <script>
    // PASS LIQUID CONFIGURATION TO JAVASCRIPT
    document.addEventListener('DOMContentLoaded', function() {
      if (typeof initEthossenceReviewForms === 'function') {
        initEthossenceReviewForms({
          animationType: '{{ s_animation_type }}',
          isCustomer: {% if customer %}true{% else %}false{% endif %}
        });
      }
    });
  </script>

{%- endif -%}

{% schema %}
{
  "name": "Review request",
  "tag": "section",
  "class": "section",
  "disabled_on": {
    "groups": ["header", "footer"]
  },
  "settings": [
    {
      "type": "header",
      "content": "Appearance"
    },    
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:sections.all.colors.label",
      "default": "scheme-1"
    },
    {
      "type": "checkbox",
      "id": "full_width",
      "default": true,
      "label": "t:sections.rich-text.settings.full_width.label"
    },
    {
      "type": "header",
      "content": "t:sections.all.padding.section_padding_heading"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "t:sections.all.padding.padding_top",
      "default": 40
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "t:sections.all.padding.padding_bottom",
      "default": 52
    }
  ],
  "blocks": [
      {
         "type": "content",
         "name": "Content from page",
         "settings": [   
            {
               "type": "header",
               "content": "Content"
            },            
            {
               "type": "page",
               "id": "page",
               "label": "t:sections.page.settings.page.label"
            },
            {
               "type": "header",
               "content": "Appearance"
            },             
            {
               "type": "checkbox",
               "id": "heading_hide",
               "default": false,
               "label": "Hide page title"
            },
            {
               "type": "select",
               "id": "heading_size",
               "options": [
               {
                  "value": "h2",
                  "label": "t:sections.all.heading_size.options__1.label"
               },
               {
                  "value": "h1",
                  "label": "t:sections.all.heading_size.options__2.label"
               },
               {
                  "value": "h0",
                  "label": "t:sections.all.heading_size.options__3.label"
               },
               {
                  "value": "hxl",
                  "label": "t:sections.all.heading_size.options__4.label"
               },
               {
                  "value": "hxxl",
                  "label": "t:sections.all.heading_size.options__5.label"
               }
               ],
               "default": "h1",
               "label": "t:sections.all.heading_size.label"
            },                      
            {
               "type": "header",
               "content": "View permissions"
            },              
            {
              "type": "select",
              "id": "content_audience",
              "options": [
                {
                  "value": "visitors",
                  "label": "Visitors without an account"
                },
                {
                  "value": "accounts",
                  "label": "Those with accounts"
                }
              ],
              "default": "visitors",
              "label": "Account status",
              "info": "If those with accounts is selected then authorization to view can be enforced."
            },
            {
              "type": "checkbox",
              "id": "authoriz_enabled",
              "default": false,
              "label": "Enforce authorization to view."
            },   
            {
               "type": "header",
               "content": "t:sections.all.padding.section_padding_heading"
            },
            {
               "type": "range",
               "id": "padding_top",
               "min": 0,
               "max": 100,
               "step": 4,
               "unit": "px",
               "label": "t:sections.all.padding.padding_top",
               "default": 36
            },
            {
               "type": "range",
               "id": "padding_bottom",
               "min": 0,
               "max": 100,
               "step": 4,
               "unit": "px",
               "label": "t:sections.all.padding.padding_bottom",
               "default": 36
            }        
         ]
      },    
      {
         "type": "form",
         "name": "Forms for review",
         "limit": 3,
         "settings": [
            {
               "type": "header",
               "content": "Appearance"
            },          
            {
              "type": "select",
              "id": "animation_type",
              "label": "Form animation",
              "options": [
                {"value": "slide_down", "label": "Slide down (dropdown)"},
                {"value": "slide_out", "label": "Slide out (drawer)"}
              ],
              "default": "slide_down"
            }, 
            {
              "type": "select",
              "id": "content_alignment",
              "options": [
                {
                  "value": "left",
                  "label": "t:sections.rich-text.settings.content_alignment.options__1.label"
                },
                {
                  "value": "center",
                  "label": "t:sections.rich-text.settings.content_alignment.options__2.label"
                },
                {
                  "value": "right",
                  "label": "t:sections.rich-text.settings.content_alignment.options__3.label"
                }
              ],
              "default": "center",
              "label": "t:sections.rich-text.settings.content_alignment.label"
            },                
            {
               "type": "header",
               "content": "Form headers"
            },                     
            {
               "type": "inline_richtext",
               "id": "create_account_head_text",
               "default": "Create Your Account",
               "label": "Account creation header"
            },
            {
               "type": "inline_richtext",
               "id": "submit_cart_head_text",
               "default": "Review Request",
               "label": "Cart review header"
            },            
            {
               "type": "select",
               "id": "heading_size",
               "options": [
                  {
                     "value": "h2",
                     "label": "t:sections.all.heading_size.options__1.label"
                  },
                  {
                     "value": "h1",
                     "label": "t:sections.all.heading_size.options__2.label"
                  },
                  {
                     "value": "h0",
                     "label": "t:sections.all.heading_size.options__3.label"
                  },
                  {
                     "value": "hxl",
                     "label": "t:sections.all.heading_size.options__4.label"
                  },
                  {
                     "value": "hxxl",
                     "label": "t:sections.all.heading_size.options__5.label"
                  }
               ],
               "default": "h1",
               "label": "t:sections.all.heading_size.label"
            },
            {
               "type": "header",
               "content": "Buttons"
            },             
            {
              "type": "text",
              "id": "btn_trigger_account_form",
              "label": "Guest trigger button",
              "default": "Create Account to Request Review &raquo;"
            },            
            {
              "type": "text",
              "id": "btn_trigger_request_form",
              "label": "Customer trigger button",
              "default": "Start Review Request"
            },
            {
               "type": "header",
               "content": "t:sections.all.padding.section_padding_heading"
            },
            {
              "type": "range",
              "id": "padding_top",
              "min": 0,
              "max": 100,
              "step": 4,
              "unit": "px",
              "label": "t:sections.all.padding.padding_top",
              "default": 40
            },
            {
              "type": "range",
              "id": "padding_bottom",
              "min": 0,
              "max": 100,
              "step": 4,
              "unit": "px",
              "label": "t:sections.all.padding.padding_bottom",
              "default": 52
            }                     
         ]
      }  
   ],
  "presets": [
    {
      "name": "Review request"
    }
  ]
}
{% endschema %}