{%- comment -%}
  ETHOSSENCE PRODUCT PARTS SECTION

  Displays products from a selected collection in a list format.
  Each product is shown as a row with image, details, variant selector (if multiple), price, and add-to-cart.

  Settings:
  - collection: Collection to display products from
  - show_collection_description: Toggle to show/hide collection description
  - alternate_row_colors: Enable alternating background colors for rows
  - alternate_row_color: Color for even rows when alternating is enabled
{%- endcomment -%}

{%- assign collection = section.settings.collection -%}

{%- if collection != blank and collection.products.size > 0 -%}
  {{ 'ethossence-product-parts.css' | asset_url | stylesheet_tag }}
  <script src="{{ 'ethossence-product-parts.js' | asset_url }}" defer="defer"></script>
  {%- if section.settings.enable_accordion -%}
    {{ 'ethossence-accordion.css' | asset_url | stylesheet_tag }}
    <script src="{{ 'ethossence-accordion.js' | asset_url }}" defer="defer"></script>
  {%- endif -%}

  {%- style -%}
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
      padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
    }

    @media screen and (min-width: 750px) {
      .section-{{ section.id }}-padding {
        padding-top: {{ section.settings.padding_top }}px;
        padding-bottom: {{ section.settings.padding_bottom }}px;
      }
    }

    /* Group heading styles */
    .section-{{ section.id }}-padding .product-parts__group-heading {
      font-size: {{ section.settings.group_heading_font_size }}px;
      {% if section.settings.group_heading_bold %}font-weight: bold;{% endif %}
    }

    /* Line separators */
    {% if section.settings.show_top_line %}
    .section-{{ section.id }}-padding .product-parts::before {
      content: '';
      display: block;
      width: 100%;
      height: 1px;
      background-color: rgba(var(--color-foreground), 0.1);
      margin-bottom: 2rem;
    }
    {% endif %}

    {% if section.settings.show_bottom_line %}
    .section-{{ section.id }}-padding .product-parts::after {
      content: '';
      display: block;
      width: 100%;
      height: 1px;
      background-color: rgba(var(--color-foreground), 0.1);
      margin-top: 2rem;
    }
    {% endif %}

    /* Alternating row colors */
    {% if section.settings.alternate_row_colors %}
    .section-{{ section.id }}-padding .product-parts__item:nth-child(even) {
      background-color: {{ section.settings.alternate_row_color }};
    }
    {% endif %}
  {%- endstyle -%}

  <div class="section-{{ section.id }}-padding color-{{ section.settings.color_scheme }} gradient">
    <div class="page-width">
      <div class="product-parts" data-section-id="{{ section.id }}"{% if section.settings.enable_accordion %} data-ethossence-accordion{% endif %}>

        {%- comment -%} Section Heading with Accordion Toggle {%- endcomment -%}
        {%- if section.settings.heading != blank -%}
          <div class="ethossence-accordion__header">
            <h2 class="product-parts__section-heading {{ section.settings.heading_size }} {{ section.settings.heading_alignment }}">
              {{ section.settings.heading }}
            </h2>
            {%- if section.settings.enable_accordion -%}
              <button type="button" class="ethossence-accordion__toggle" data-accordion-toggle>
                <span data-expand-text>+ {{ 'sections.accordion.expand' | t | default: 'expand' }}</span>
                <span data-collapse-text>- {{ 'sections.accordion.collapse' | t | default: 'collapse' }}</span>
              </button>
            {%- endif -%}
          </div>
        {%- endif -%}

        {%- comment -%} Accordion content wrapper {%- endcomment -%}
        <div class="{% if section.settings.enable_accordion %}ethossence-accordion__content{% endif %}"{% if section.settings.enable_accordion %} data-accordion-content{% endif %}>
        <div class="product-parts__group">

          {%- comment -%} Group Heading = Collection Title {%- endcomment -%}
          <div class="product-parts__group-header">
            <h3 class="product-parts__group-heading">
              {{ collection.title }}
            </h3>
          </div>

          {%- comment -%} Group Note = Collection Description (optional) {%- endcomment -%}
          {%- if section.settings.show_collection_description and collection.description != blank -%}
            <div class="product-parts__group-note rte">
              {{ collection.description }}
            </div>
          {%- endif -%}

          <div class="product-parts__items-list">

            {%- comment -%} Loop through products (one row per product, with variant selector if needed) {%- endcomment -%}
            {%- for collection_product in collection.products -%}
              {%- assign first_available_variant = collection_product.selected_or_first_available_variant -%}
              {%- assign has_multiple_variants = false -%}
              {%- if collection_product.variants.size > 1 -%}
                {%- assign has_multiple_variants = true -%}
              {%- endif -%}

              {%- comment -%} Prepare price display variables {%- endcomment -%}
              {%- liquid
                assign money_price = first_available_variant.price | money
                if settings.currency_code_enabled
                  assign money_price = first_available_variant.price | money_with_currency
                endif
                if collection_product.price_varies
                  assign money_price = 'products.product.price.from_price_html' | t: price: money_price
                endif
              -%}

              <div class="product-parts__item" data-product-id="{{ collection_product.id }}">

                {%- comment -%} Product Image {%- endcomment -%}
                <div class="product-parts__item-image">
                  {%- if collection_product.featured_image != blank -%}
                    {{ collection_product.featured_image | image_url: width: 300 | image_tag:
                      loading: 'lazy',
                      widths: '150, 300, 450',
                      sizes: '(min-width: 750px) 200px, 150px',
                      alt: collection_product.title
                    }}
                  {%- else -%}
                    <div class="product-parts__no-image">
                      {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
                    </div>
                  {%- endif -%}
                </div>

                {%- comment -%} Item Details {%- endcomment -%}
                <div class="product-parts__item-details">
                  <h5 class="product-parts__item-title">
                    <a href="{{ collection_product.url }}">
                      {{ collection_product.title }}
                    </a>
                  </h5>

                  {%- comment -%} Variant Selector (if multiple variants) {%- endcomment -%}
                  {%- if has_multiple_variants -%}
                    <div class="product-parts__variant-selector">
                      <select
                        class="product-parts__variant-select"
                        data-product-id="{{ collection_product.id }}"
                        onchange="productPartsUpdateVariant(this)"
                      >
                        {%- for variant in collection_product.variants -%}
                          <option
                            value="{{ variant.id }}"
                            data-price="{{ variant.price | money }}"
                            data-compare-price="{{ variant.compare_at_price | money }}"
                            data-available="{{ variant.available }}"
                            data-sku="{{ variant.sku }}"
                            {% if variant == first_available_variant %}selected{% endif %}
                          >
                            {{ variant.title }}{% unless variant.available %} - {{ 'products.product.sold_out' | t }}{% endunless %} - {{ variant.price | money }}
                          </option>
                        {%- endfor -%}
                      </select>
                    </div>
                  {%- endif -%}

                  {%- if first_available_variant.sku != blank -%}
                    <p class="product-parts__item-sku" data-sku-display="{{ collection_product.id }}">
                      SKU: {{ first_available_variant.sku }}
                    </p>
                  {%- endif -%}
                </div>

                {%- comment -%} Description {%- endcomment -%}
                {%- if collection_product.description != blank -%}
                  <div class="product-parts__item-description">
                    {%- assign description_text = collection_product.description | strip_html -%}
                    {%- if description_text.size > 174 -%}
                      {{ description_text | truncate: 174, '...' }}
                      <a href="{{ collection_product.url }}" class="product-parts__learn-more">{{ 'general.continue_reading' | t | default: 'View product' }}</a>
                    {%- else -%}
                      {{ description_text }}
                    {%- endif -%}
                  </div>
                {%- endif -%}

                {%- comment -%} Price {%- endcomment -%}
                <div class="product-parts__item-price" data-price-display="{{ collection_product.id }}" data-price-varies="{{ collection_product.price_varies }}">
                  {%- if first_available_variant.compare_at_price > first_available_variant.price -%}
                    <span class="product-parts__price--sale">
                      {{ money_price }}
                    </span>
                    <span class="product-parts__price--compare">
                      <s>{{ first_available_variant.compare_at_price | money }}</s>
                    </span>
                  {%- else -%}
                    <span class="product-parts__price">
                      {{ money_price }}
                    </span>
                  {%- endif -%}
                </div>

                {%- comment -%} Add to Cart {%- endcomment -%}
                <div class="product-parts__item-action">
                  <button
                    type="button"
                    class="button product-parts__add-btn js-product-parts-add-to-cart"
                    data-variant-id="{{ first_available_variant.id }}"
                    data-variant-input="{{ collection_product.id }}"
                    data-product-title="{{ collection_product.title | escape }}"
                    data-add-btn="{{ collection_product.id }}"
                    data-add-to-cart-text="{{ 'products.product.add_to_cart' | t }}"
                    data-sold-out-text="{{ 'products.product.sold_out' | t }}"
                    data-adding-text="{{ 'products.product.adding' | t | default: 'Adding...' }}"
                    data-added-text="{{ 'products.product.added' | t | default: 'Added!' }}"
                    data-error-text="{{ 'products.product.error' | t | default: 'Error - Try Again' }}"
                    {% unless first_available_variant.available %}disabled{% endunless %}
                  >
                    {%- if first_available_variant.available -%}
                      {{ 'products.product.add_to_cart' | t }}
                    {%- else -%}
                      {{ 'products.product.sold_out' | t }}
                    {%- endif -%}
                  </button>
                </div>

              </div>
            {%- endfor -%}

          </div>
        </div>
        </div>{%- comment -%} Close accordion content wrapper {%- endcomment -%}

      </div>
    </div>
  </div>
{%- endif -%}

{% schema %}
{
  "name": "Parts",
  "tag": "section",
  "class": "section",
  "enabled_on": {
    "templates": ["product"]
  },
  "settings": [
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection"
    },
    {
      "type": "inline_richtext",
      "id": "heading",
      "label": "Heading",
      "default": "Product Parts"
    },
    {
      "type": "select",
      "id": "heading_size",
      "options": [
        {
          "value": "h2",
          "label": "t:sections.all.heading_size.options__1.label"
        },
        {
          "value": "h1",
          "label": "t:sections.all.heading_size.options__2.label"
        },
        {
          "value": "h0",
          "label": "t:sections.all.heading_size.options__3.label"
        },
        {
          "value": "hxl",
          "label": "t:sections.all.heading_size.options__4.label"
        },
        {
          "value": "hxxl",
          "label": "t:sections.all.heading_size.options__5.label"
        }
      ],
      "default": "h1",
      "label": "t:sections.all.heading_size.label"
    },
    {
      "type": "select",
      "id": "heading_alignment",
      "options": [
        {
          "value": "left",
          "label": "Left"
        },
        {
          "value": "center",
          "label": "Center"
        },
        {
          "value": "right",
          "label": "Right"
        }
      ],
      "default": "left",
      "label": "Heading alignment"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:sections.all.colors.label",
      "default": "scheme-1"
    },
    {
      "type": "header",
      "content": "Collection description"
    },
    {
      "type": "checkbox",
      "id": "show_collection_description",
      "label": "Show collection description",
      "default": true
    },
    {
      "type": "header",
      "content": "Group heading styling"
    },
    {
      "type": "range",
      "id": "group_heading_font_size",
      "min": 12,
      "max": 30,
      "step": 1,
      "unit": "px",
      "label": "Group heading font size",
      "default": 18
    },
    {
      "type": "checkbox",
      "id": "group_heading_bold",
      "label": "Group heading bold",
      "default": false
    },
    {
      "type": "header",
      "content": "Row styling"
    },
    {
      "type": "checkbox",
      "id": "alternate_row_colors",
      "label": "Alternate row background colors",
      "default": false
    },
    {
      "type": "color",
      "id": "alternate_row_color",
      "label": "Alternate row background color",
      "default": "#f5f5f5"
    },
    {
      "type": "header",
      "content": "Line separators"
    },
    {
      "type": "checkbox",
      "id": "show_top_line",
      "label": "Show line at top of section",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "show_bottom_line",
      "label": "Show line at bottom of section",
      "default": false
    },
    {
      "type": "header",
      "content": "Accordion"
    },
    {
      "type": "checkbox",
      "id": "enable_accordion",
      "label": "Enable accordion expand/collapse",
      "default": false
    },
    {
      "type": "header",
      "content": "Section padding"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "t:sections.all.padding.padding_top",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "t:sections.all.padding.padding_bottom",
      "default": 36
    }
  ],
  "presets": [
    {
      "name": "Parts",
      "category": "Ethossence - products"
    }
  ]
}
{% endschema %}
