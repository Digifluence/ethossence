{%- comment -%}
  ETHOSSENCE PRODUCT COMPLETE SOLUTION SECTION

  Displays complete system/solution recommendations for products.
  Shows groups of recommended products and variants to complement the main product.

  Metafield: ethossence.solutions_complete (list metaobject reference)
  Metaobject type: solutions_complete
  Fields:
    - group_heading (single line text)
    - group_note (multi-line text)
    - group_required_choice (boolean)
    - complete_system_products (list product) - displays all variants of each product
    - complete_system_product_variants (list product variant) - displays specific variants
{%- endcomment -%}

{%- liquid
  # Get the solutions_complete metaobject list from the product
  assign solution_groups = product.metafields.ethossence.solutions_complete.value

  # Check if there are any solution groups
  assign show_section = false
  if solution_groups != blank
    for group in solution_groups
      assign show_section = true
      break
    endfor
  endif
-%}

{%- if show_section -%}
  {{ 'ethossence-product-complete-solution.css' | asset_url | stylesheet_tag }}
  <script src="{{ 'ethossence-product-complete-solution.js' | asset_url }}" defer="defer"></script>

  {%- style -%}
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
      padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
    }

    @media screen and (min-width: 750px) {
      .section-{{ section.id }}-padding {
        padding-top: {{ section.settings.padding_top }}px;
        padding-bottom: {{ section.settings.padding_bottom }}px;
      }
    }
  {%- endstyle -%}

  <div class="section-{{ section.id }}-padding color-{{ section.settings.color_scheme }} gradient">
    <div class="page-width">
      <div class="complete-solution">

        {%- comment -%} Section Heading {%- endcomment -%}
        {%- if section.settings.heading != blank -%}
          <h2 class="complete-solution__section-heading {{ section.settings.heading_size }}">
            {{ section.settings.heading }}
          </h2>
        {%- endif -%}

        {%- comment -%} Loop through each solution group {%- endcomment -%}
        {%- for group in solution_groups -%}
          <div class="complete-solution__group">

            {%- comment -%} Group Heading {%- endcomment -%}
            {%- if group.group_heading != blank -%}
              <div class="complete-solution__header">
                <h3 class="complete-solution__group-heading">
                  {{ group.group_heading }}
                  {%- if group.group_required_choice -%}
                    <span class="complete-solution__required-badge">Required</span>
                  {%- endif -%}
                </h3>
              </div>
            {%- endif -%}

            {%- comment -%} Group Note {%- endcomment -%}
            {%- if group.group_note != blank -%}
              <div class="complete-solution__note rte">
                {{ group.group_note }}
              </div>
            {%- endif -%}

            <div class="complete-solution__items-list">

              {%- comment -%} Complete System Products - Display product with variant selector {%- endcomment -%}
              {%- assign system_products = group.complete_system_products.value -%}
              {%- if system_products != blank -%}
                {%- for system_product in system_products -%}
                  {%- assign first_available_variant = system_product.selected_or_first_available_variant -%}
                  {%- assign has_multiple_variants = false -%}
                  {%- if system_product.variants.size > 1 -%}
                    {%- assign has_multiple_variants = true -%}
                  {%- endif -%}

                  {%- comment -%} Prepare price display variables {%- endcomment -%}
                  {%- liquid
                    assign money_price = first_available_variant.price | money
                    if settings.currency_code_enabled
                      assign money_price = first_available_variant.price | money_with_currency
                    endif
                    if system_product.price_varies
                      assign money_price = 'products.product.price.from_price_html' | t: price: money_price
                    endif
                  -%}

                  <div class="complete-solution__item" data-product-id="{{ system_product.id }}">

                    {%- comment -%} Product Image {%- endcomment -%}
                    <div class="complete-solution__item-image">
                      {%- if system_product.featured_image != blank -%}
                        {{ system_product.featured_image | image_url: width: 300 | image_tag:
                          loading: 'lazy',
                          widths: '150, 300, 450',
                          sizes: '(min-width: 750px) 200px, 150px',
                          alt: system_product.title
                        }}
                      {%- else -%}
                        <div class="complete-solution__no-image">
                          {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
                        </div>
                      {%- endif -%}
                    </div>

                    {%- comment -%} Item Details {%- endcomment -%}
                    <div class="complete-solution__item-details">
                      <h4 class="complete-solution__item-title">
                        <a href="{{ system_product.url }}">
                          {{ system_product.title }}
                        </a>
                      </h4>

                      {%- comment -%} Variant Selector (if multiple variants) {%- endcomment -%}
                      {%- if has_multiple_variants -%}
                        <div class="complete-solution__variant-selector">
                          <select
                            class="complete-solution__variant-select"
                            data-product-id="{{ system_product.id }}"
                            onchange="completeSolutionUpdateVariant(this)"
                          >
                            {%- for variant in system_product.variants -%}
                              <option
                                value="{{ variant.id }}"
                                data-price="{{ variant.price | money }}"
                                data-compare-price="{{ variant.compare_at_price | money }}"
                                data-available="{{ variant.available }}"
                                data-sku="{{ variant.sku }}"
                                {% if variant == first_available_variant %}selected{% endif %}
                              >
                                {{ variant.title }}{% unless variant.available %} - {{ 'products.product.sold_out' | t }}{% endunless %} - {{ variant.price | money }}
                              </option>
                            {%- endfor -%}
                          </select>
                        </div>
                      {%- endif -%}

                      {%- if first_available_variant.sku != blank -%}
                        <p class="complete-solution__item-sku" data-sku-display="{{ system_product.id }}">
                          SKU: {{ first_available_variant.sku }}
                        </p>
                      {%- endif -%}
                    </div>

                    {%- comment -%} Description {%- endcomment -%}
                    {%- if system_product.description != blank -%}
                      <div class="complete-solution__item-description">
                        {%- assign description_text = system_product.description | strip_html -%}
                        {%- if description_text.size > 300 -%}
                          {{ description_text | truncate: 300, '...' }}
                          <a href="{{ system_product.url }}" class="complete-solution__learn-more">{{ 'general.continue_reading' | t | default: 'Learn more' }}</a>
                        {%- else -%}
                          {{ description_text }}
                        {%- endif -%}
                      </div>
                    {%- endif -%}

                    {%- comment -%} Price {%- endcomment -%}
                    <div class="complete-solution__item-price" data-price-display="{{ system_product.id }}" data-price-varies="{{ system_product.price_varies }}">
                      {%- if first_available_variant.compare_at_price > first_available_variant.price -%}
                        <span class="complete-solution__price--sale">
                          {{ money_price }}
                        </span>
                        <span class="complete-solution__price--compare">
                          <s>{{ first_available_variant.compare_at_price | money }}</s>
                        </span>
                      {%- else -%}
                        <span class="complete-solution__price">
                          {{ money_price }}
                        </span>
                      {%- endif -%}
                    </div>

                    {%- comment -%} Add to Cart {%- endcomment -%}
                    <div class="complete-solution__item-action">
                      <button
                        type="button"
                        class="button complete-solution__add-btn js-complete-solution-add-to-cart"
                        data-variant-id="{{ first_available_variant.id }}"
                        data-variant-input="{{ system_product.id }}"
                        data-product-title="{{ system_product.title | escape }}"
                        data-add-btn="{{ system_product.id }}"
                        data-add-to-cart-text="{{ 'products.product.add_to_cart' | t }}"
                        data-sold-out-text="{{ 'products.product.sold_out' | t }}"
                        data-adding-text="{{ 'products.product.adding' | t | default: 'Adding...' }}"
                        data-added-text="{{ 'products.product.added' | t | default: 'Added!' }}"
                        data-error-text="{{ 'products.product.error' | t | default: 'Error - Try Again' }}"
                        {% unless first_available_variant.available %}disabled{% endunless %}
                      >
                        {%- if first_available_variant.available -%}
                          {{ 'products.product.add_to_cart' | t }}
                        {%- else -%}
                          {{ 'products.product.sold_out' | t }}
                        {%- endif -%}
                      </button>
                    </div>

                  </div>
                {%- endfor -%}
              {%- endif -%}

              {%- comment -%} Complete System Product Variants - Display specific pre-selected variants {%- endcomment -%}
              {%- assign system_variants = group.complete_system_product_variants.value -%}
              {%- if system_variants != blank and system_variants.size > 0 -%}
                {%- for variant in system_variants -%}
                  {%- assign variant_product = variant.product -%}
                  <div class="complete-solution__item">

                    {%- comment -%} Variant Image {%- endcomment -%}
                    <div class="complete-solution__item-image">
                      {%- if variant.image != blank -%}
                        {{ variant.image | image_url: width: 300 | image_tag:
                          loading: 'lazy',
                          widths: '150, 300, 450',
                          sizes: '(min-width: 750px) 200px, 150px',
                          alt: variant.title
                        }}
                      {%- elsif variant_product.featured_image != blank -%}
                        {{ variant_product.featured_image | image_url: width: 300 | image_tag:
                          loading: 'lazy',
                          widths: '150, 300, 450',
                          sizes: '(min-width: 750px) 200px, 150px',
                          alt: variant_product.title
                        }}
                      {%- else -%}
                        <div class="complete-solution__no-image">
                          {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
                        </div>
                      {%- endif -%}
                    </div>

                    {%- comment -%} Item Details {%- endcomment -%}
                    <div class="complete-solution__item-details">
                      <h4 class="complete-solution__item-title">
                        <a href="{{ variant_product.url }}">
                          {{ variant_product.title }}
                        </a>
                      </h4>

                      {%- if variant.title != 'Default Title' -%}
                        <p class="complete-solution__item-variant">
                          {{ variant.title }}
                        </p>
                      {%- endif -%}

                      {%- if variant.sku != blank -%}
                        <p class="complete-solution__item-sku">
                          SKU: {{ variant.sku }}
                        </p>
                      {%- endif -%}
                    </div>

                    {%- comment -%} Description {%- endcomment -%}
                    {%- if variant_product.description != blank -%}
                      <div class="complete-solution__item-description">
                        {%- assign description_text = variant_product.description | strip_html -%}
                        {%- if description_text.size > 300 -%}
                          {{ description_text | truncate: 300, '...' }}
                          <a href="{{ variant_product.url }}" class="complete-solution__learn-more">{{ 'general.continue_reading' | t | default: 'Learn more' }}</a>
                        {%- else -%}
                          {{ description_text }}
                        {%- endif -%}
                      </div>
                    {%- endif -%}

                    {%- comment -%} Price {%- endcomment -%}
                    <div class="complete-solution__item-price">
                      {%- if variant.compare_at_price > variant.price -%}
                        <span class="complete-solution__price--sale">
                          {{ variant.price | money }}
                        </span>
                        <span class="complete-solution__price--compare">
                          <s>{{ variant.compare_at_price | money }}</s>
                        </span>
                      {%- else -%}
                        <span class="complete-solution__price">
                          {{ variant.price | money }}
                        </span>
                      {%- endif -%}
                    </div>

                    {%- comment -%} Add to Cart {%- endcomment -%}
                    <div class="complete-solution__item-action">
                      <button
                        type="button"
                        class="button complete-solution__add-btn js-complete-solution-add-to-cart"
                        data-variant-id="{{ variant.id }}"
                        data-product-title="{{ variant_product.title | escape }}{% if variant.title != 'Default Title' %} - {{ variant.title | escape }}{% endif %}"
                        data-add-to-cart-text="{{ 'products.product.add_to_cart' | t }}"
                        data-sold-out-text="{{ 'products.product.sold_out' | t }}"
                        data-adding-text="{{ 'products.product.adding' | t | default: 'Adding...' }}"
                        data-added-text="{{ 'products.product.added' | t | default: 'Added!' }}"
                        data-error-text="{{ 'products.product.error' | t | default: 'Error - Try Again' }}"
                        {% unless variant.available %}disabled{% endunless %}
                      >
                        {%- if variant.available -%}
                          {{ 'products.product.add_to_cart' | t }}
                        {%- else -%}
                          {{ 'products.product.sold_out' | t }}
                        {%- endif -%}
                      </button>
                    </div>

                  </div>
                {%- endfor -%}
              {%- endif -%}

            </div>
          </div>
        {%- endfor -%}

      </div>
    </div>
  </div>
{%- endif -%}

{% schema %}
{
  "name": "Complete solution",
  "tag": "section",
  "class": "section",
  "enabled_on": {
    "templates": ["product"]
  },
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Section heading",
      "default": "Complete Your System"
    },
    {
      "type": "select",
      "id": "heading_size",
      "options": [
        {
          "value": "h2",
          "label": "t:sections.all.heading_size.options__1.label"
        },
        {
          "value": "h1",
          "label": "t:sections.all.heading_size.options__2.label"
        },
        {
          "value": "h0",
          "label": "t:sections.all.heading_size.options__3.label"
        },
        {
          "value": "hxl",
          "label": "t:sections.all.heading_size.options__4.label"
        },
        {
          "value": "hxxl",
          "label": "t:sections.all.heading_size.options__5.label"
        }
      ],
      "default": "h1",
      "label": "t:sections.all.heading_size.label"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:sections.all.colors.label",
      "default": "scheme-1"
    },
    {
      "type": "header",
      "content": "Section padding"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "t:sections.all.padding.padding_top",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "t:sections.all.padding.padding_bottom",
      "default": 36
    }
  ],
  "presets": [
    {
      "name": "Complete solution",
      "category": "Ethossence"
    }
  ]
}
{% endschema %}
