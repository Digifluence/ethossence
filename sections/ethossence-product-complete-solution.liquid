{%- comment -%}
  ETHOSSENCE PRODUCT COMPLETE SOLUTION SECTION

  Displays complete system/solution recommendations for products.
  Shows groups of recommended products and variants to complement the main product.

  Metafield: ethossence.solutions_complete (list metaobject reference)
  Metaobject type: solutions_complete
  Fields:
    - group_heading (single line text)
    - group_note (multi-line text)
    - group_required_choice (boolean)
    - complete_system_products (list product) - displays all variants of each product
    - complete_system_product_variants (list product variant) - displays specific variants
{%- endcomment -%}

{%- liquid
  # Get the solutions_complete metaobject list from the product
  assign solution_groups = product.metafields.ethossence.solutions_complete.value

  # Check if there are any solution groups
  assign show_section = false
  if solution_groups != blank
    for group in solution_groups
      assign show_section = true
      break
    endfor
  endif
-%}

<pre>Hello 2026-01-19 A</pre>

{%- if show_section -%}
  {{ 'ethossence-product-complete-solution.css' | asset_url | stylesheet_tag }}

  {%- style -%}
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
      padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
    }

    @media screen and (min-width: 750px) {
      .section-{{ section.id }}-padding {
        padding-top: {{ section.settings.padding_top }}px;
        padding-bottom: {{ section.settings.padding_bottom }}px;
      }
    }
  {%- endstyle -%}

  <div class="section-{{ section.id }}-padding color-{{ section.settings.color_scheme }} gradient">
    <div class="page-width">
      <div class="complete-solution">

        {%- comment -%} Section Heading {%- endcomment -%}
        {%- if section.settings.heading != blank -%}
          <h2 class="complete-solution__section-heading {{ section.settings.heading_size }}">
            {{ section.settings.heading }}
          </h2>
        {%- endif -%}

        {%- comment -%} Loop through each solution group {%- endcomment -%}
        {%- for group in solution_groups -%}
          <div class="complete-solution__group">

            {%- comment -%} Group Heading {%- endcomment -%}
            {%- if group.group_heading != blank -%}
              <div class="complete-solution__header">
                <h3 class="complete-solution__group-heading">
                  {{ group.group_heading }}
                  {%- if group.group_required_choice -%}
                    <span class="complete-solution__required-badge">Required</span>
                  {%- endif -%}
                </h3>
              </div>
            {%- endif -%}

            {%- comment -%} Group Note {%- endcomment -%}
            {%- if group.group_note != blank -%}
              <div class="complete-solution__note rte">
                {{ group.group_note }}
              </div>
            {%- endif -%}

            <div class="complete-solution__items-list">

              {%- comment -%} Complete System Products - Display product with variant selector {%- endcomment -%}
              {%- assign system_products = group.complete_system_products.value -%}
              {%- if system_products != blank -%}
                {%- for system_product in system_products -%}
                  {%- assign first_available_variant = system_product.selected_or_first_available_variant -%}
                  {%- assign has_multiple_variants = false -%}
                  {%- if system_product.variants.size > 1 -%}
                    {%- assign has_multiple_variants = true -%}
                  {%- endif -%}

                  <div class="complete-solution__item" data-product-id="{{ system_product.id }}">

                    {%- comment -%} Product Image {%- endcomment -%}
                    <div class="complete-solution__item-image">
                      {%- if system_product.featured_image != blank -%}
                        {{ system_product.featured_image | image_url: width: 300 | image_tag:
                          loading: 'lazy',
                          widths: '150, 300, 450',
                          sizes: '(min-width: 750px) 200px, 150px',
                          alt: system_product.title
                        }}
                      {%- else -%}
                        <div class="complete-solution__no-image">
                          {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
                        </div>
                      {%- endif -%}
                    </div>

                    {%- comment -%} Item Details {%- endcomment -%}
                    <div class="complete-solution__item-details">
                      <h4 class="complete-solution__item-title">
                        <a href="{{ system_product.url }}">
                          {{ system_product.title }}
                        </a>
                      </h4>

                      {%- comment -%} Variant Selector (if multiple variants) {%- endcomment -%}
                      {%- if has_multiple_variants -%}
                        <div class="complete-solution__variant-selector">
                          <select
                            class="complete-solution__variant-select"
                            data-product-id="{{ system_product.id }}"
                            onchange="completeSolutionUpdateVariant(this)"
                          >
                            {%- for variant in system_product.variants -%}
                              <option
                                value="{{ variant.id }}"
                                data-price="{{ variant.price | money }}"
                                data-compare-price="{{ variant.compare_at_price | money }}"
                                data-available="{{ variant.available }}"
                                data-sku="{{ variant.sku }}"
                                {% if variant == first_available_variant %}selected{% endif %}
                              >
                                {{ variant.title }}{% unless variant.available %} - {{ 'products.product.sold_out' | t }}{% endunless %} - {{ variant.price | money }}
                              </option>
                            {%- endfor -%}
                          </select>
                        </div>
                      {%- endif -%}

                      {%- if first_available_variant.sku != blank -%}
                        <p class="complete-solution__item-sku" data-sku-display="{{ system_product.id }}">
                          SKU: {{ first_available_variant.sku }}
                        </p>
                      {%- endif -%}
                    </div>

                    {%- comment -%} Price {%- endcomment -%}
                    <div class="complete-solution__item-price" data-price-display="{{ system_product.id }}">
                      {%- if first_available_variant.compare_at_price > first_available_variant.price -%}
                        <span class="complete-solution__price--sale">
                          {{ first_available_variant.price | money }}
                        </span>
                        <span class="complete-solution__price--compare">
                          <s>{{ first_available_variant.compare_at_price | money }}</s>
                        </span>
                      {%- else -%}
                        <span class="complete-solution__price">
                          {{ first_available_variant.price | money }}
                        </span>
                      {%- endif -%}
                    </div>

                    {%- comment -%} Add to Cart {%- endcomment -%}
                    <div class="complete-solution__item-action">
                      <button
                        type="button"
                        class="button complete-solution__add-btn js-complete-solution-add-to-cart"
                        data-variant-id="{{ first_available_variant.id }}"
                        data-variant-input="{{ system_product.id }}"
                        data-product-title="{{ system_product.title | escape }}"
                        data-add-btn="{{ system_product.id }}"
                        {% unless first_available_variant.available %}disabled{% endunless %}
                      >
                        {%- if first_available_variant.available -%}
                          {{ 'products.product.add_to_cart' | t }}
                        {%- else -%}
                          {{ 'products.product.sold_out' | t }}
                        {%- endif -%}
                      </button>
                    </div>

                  </div>
                {%- endfor -%}
              {%- endif -%}

              {%- comment -%} Complete System Product Variants - Display specific pre-selected variants {%- endcomment -%}
              {%- assign system_variants = group.complete_system_product_variants.value -%}
              {%- if system_variants != blank and system_variants.size > 0 -%}
                {%- for variant in system_variants -%}
                  {%- assign variant_product = variant.product -%}
                  <div class="complete-solution__item">

                    {%- comment -%} Variant Image {%- endcomment -%}
                    <div class="complete-solution__item-image">
                      {%- if variant.image != blank -%}
                        {{ variant.image | image_url: width: 300 | image_tag:
                          loading: 'lazy',
                          widths: '150, 300, 450',
                          sizes: '(min-width: 750px) 200px, 150px',
                          alt: variant.title
                        }}
                      {%- elsif variant_product.featured_image != blank -%}
                        {{ variant_product.featured_image | image_url: width: 300 | image_tag:
                          loading: 'lazy',
                          widths: '150, 300, 450',
                          sizes: '(min-width: 750px) 200px, 150px',
                          alt: variant_product.title
                        }}
                      {%- else -%}
                        <div class="complete-solution__no-image">
                          {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
                        </div>
                      {%- endif -%}
                    </div>

                    {%- comment -%} Item Details {%- endcomment -%}
                    <div class="complete-solution__item-details">
                      <h4 class="complete-solution__item-title">
                        <a href="{{ variant_product.url }}">
                          {{ variant_product.title }}
                        </a>
                      </h4>

                      {%- if variant.title != 'Default Title' -%}
                        <p class="complete-solution__item-variant">
                          {{ variant.title }}
                        </p>
                      {%- endif -%}

                      {%- if variant.sku != blank -%}
                        <p class="complete-solution__item-sku">
                          SKU: {{ variant.sku }}
                        </p>
                      {%- endif -%}
                    </div>

                    {%- comment -%} Price {%- endcomment -%}
                    <div class="complete-solution__item-price">
                      {%- if variant.compare_at_price > variant.price -%}
                        <span class="complete-solution__price--sale">
                          {{ variant.price | money }}
                        </span>
                        <span class="complete-solution__price--compare">
                          <s>{{ variant.compare_at_price | money }}</s>
                        </span>
                      {%- else -%}
                        <span class="complete-solution__price">
                          {{ variant.price | money }}
                        </span>
                      {%- endif -%}
                    </div>

                    {%- comment -%} Add to Cart {%- endcomment -%}
                    <div class="complete-solution__item-action">
                      <button
                        type="button"
                        class="button complete-solution__add-btn js-complete-solution-add-to-cart"
                        data-variant-id="{{ variant.id }}"
                        data-product-title="{{ variant_product.title | escape }}{% if variant.title != 'Default Title' %} - {{ variant.title | escape }}{% endif %}"
                        {% unless variant.available %}disabled{% endunless %}
                      >
                        {%- if variant.available -%}
                          {{ 'products.product.add_to_cart' | t }}
                        {%- else -%}
                          {{ 'products.product.sold_out' | t }}
                        {%- endif -%}
                      </button>
                    </div>

                  </div>
                {%- endfor -%}
              {%- endif -%}

            </div>
          </div>
        {%- endfor -%}

      </div>
    </div>
  </div>

  <style>
    .complete-solution-toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: #4caf50;
      color: white;
      padding: 16px 24px;
      border-radius: 4px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      z-index: 9999;
      font-size: 14px;
      font-weight: 500;
      animation: completeSolutionSlideIn 0.3s ease-out;
    }

    @keyframes completeSolutionSlideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes completeSolutionSlideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }

    .complete-solution-toast.hide {
      animation: completeSolutionSlideOut 0.3s ease-out forwards;
    }
  </style>

  <script>
    function completeSolutionUpdateVariant(selectElement) {
      const productId = selectElement.dataset.productId;
      const selectedOption = selectElement.options[selectElement.selectedIndex];
      const variantId = selectedOption.value;
      const price = selectedOption.dataset.price;
      const comparePrice = selectedOption.dataset.comparePrice;
      const available = selectedOption.dataset.available === 'true';
      const sku = selectedOption.dataset.sku;

      // Update the button's variant ID
      const addBtn = document.querySelector(`[data-variant-input="${productId}"]`);
      if (addBtn) {
        addBtn.dataset.variantId = variantId;
      }

      // Update price display
      const priceDisplay = document.querySelector(`[data-price-display="${productId}"]`);
      if (priceDisplay) {
        if (comparePrice && comparePrice !== price) {
          priceDisplay.innerHTML = `
            <span class="complete-solution__price--sale">${price}</span>
            <span class="complete-solution__price--compare"><s>${comparePrice}</s></span>
          `;
        } else {
          priceDisplay.innerHTML = `<span class="complete-solution__price">${price}</span>`;
        }
      }

      // Update SKU display
      const skuDisplay = document.querySelector(`[data-sku-display="${productId}"]`);
      if (skuDisplay) {
        skuDisplay.textContent = sku ? `SKU: ${sku}` : '';
      }

      // Update add to cart button availability
      const btn = document.querySelector(`[data-add-btn="${productId}"]`);
      if (btn) {
        if (available) {
          btn.disabled = false;
          btn.textContent = '{{ "products.product.add_to_cart" | t }}';
        } else {
          btn.disabled = true;
          btn.textContent = '{{ "products.product.sold_out" | t }}';
        }
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      const buttons = document.querySelectorAll('.js-complete-solution-add-to-cart');

      buttons.forEach(button => {
        button.addEventListener('click', handleCompleteSolutionAddToCart);
      });

      function showCompleteSolutionToast(message) {
        const toast = document.createElement('div');
        toast.className = 'complete-solution-toast';
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
          toast.classList.add('hide');
          setTimeout(() => {
            toast.remove();
          }, 300);
        }, 3000);
      }

      function handleCompleteSolutionAddToCart(e) {
        e.preventDefault();
        e.stopPropagation();

        const btn = e.currentTarget;
        const variantId = btn.getAttribute('data-variant-id');
        const productTitle = btn.getAttribute('data-product-title');
        const originalText = btn.textContent.trim();

        if (!variantId) {
          console.error('Variant ID not found');
          return;
        }

        btn.disabled = true;
        btn.textContent = '{{ "products.product.adding" | t | default: "Adding..." }}';

        const cartUrl = (window.Shopify && window.Shopify.routes && window.Shopify.routes.root)
          ? window.Shopify.routes.root + 'cart/add.js'
          : '/cart/add.js';

        fetch(cartUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            items: [{
              id: parseInt(variantId),
              quantity: 1
            }]
          })
        })
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          btn.textContent = '{{ "products.product.added" | t | default: "Added!" }}';
          showCompleteSolutionToast(productTitle + ' added to cart!');

          setTimeout(() => {
            btn.textContent = originalText;
            btn.disabled = false;
          }, 2000);

          document.dispatchEvent(new CustomEvent('cart:updated', {
            detail: {
              product: productTitle,
              items: data
            }
          }));
        })
        .catch(error => {
          console.error('Error adding to cart:', error);
          btn.textContent = 'Error - Try Again';
          btn.disabled = false;

          setTimeout(() => {
            btn.textContent = originalText;
          }, 3000);
        });
      }
    });
  </script>
{%- endif -%}

{% schema %}
{
  "name": "Complete Solution",
  "tag": "section",
  "class": "section",
  "enabled_on": {
    "templates": ["product"]
  },
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Section heading",
      "default": "Complete Your System"
    },
    {
      "type": "select",
      "id": "heading_size",
      "label": "Heading size",
      "options": [
        { "value": "h2", "label": "Small" },
        { "value": "h1", "label": "Medium" },
        { "value": "h0", "label": "Large" }
      ],
      "default": "h1"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:sections.all.colors.label",
      "default": "scheme-1"
    },
    {
      "type": "header",
      "content": "Section padding"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "t:sections.all.padding.padding_top",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "t:sections.all.padding.padding_bottom",
      "default": 36
    }
  ],
  "presets": [
    {
      "name": "Complete Solution",
      "category": "Ethossence"
    }
  ]
}
{% endschema %}
