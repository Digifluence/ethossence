{{ 'ethossence-video-resources.css' | asset_url | stylesheet_tag }}
<script src="{{ 'ethossence-video-resources.js' | asset_url }}" defer="defer"></script>

{%- style -%}
  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
  }

  @media screen and (min-width: 750px) {
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    }
  }
{%- endstyle -%}

{%- liquid
  assign video_resources = product.metafields.ethossence.video_resources.value
  
  # ETHOSSENCE FEATURE: AUTHORIZATION FOR VIDEO RESOURCES
  # FILTER VIDEO RESOURCES BASED ON CUSTOMER AUTHORIZATION
  
  # GET CUSTOMER AUTHORIZATION LEVEL
  assign customer_authorization_level = blank
  
  if customer
    assign customer_auth_metaobject = customer.metafields.ethossence.authorization_show.value
    
    if customer_auth_metaobject
      # ACCESS THE LEVEL FIELD OF THE METAOBJECT
      if customer_auth_metaobject.level
        assign level_value = customer_auth_metaobject.level
        if level_value != blank
          assign customer_authorization_level = level_value | downcase | strip
        endif
      endif
    endif
  endif
  
  # FILTER AUTHORIZED VIDEO RESOURCES
  assign authorized_resources = blank

  for resource in video_resources
    assign resource_authorized = false
    assign resource_has_authorization = false

    # CHECK IF RESOURCE HAS AUTHORIZATION REQUIREMENTS
    if resource.authorization.value
      assign resource_auth_metaobject = resource.authorization.value
      assign resource_has_authorization = true

      # GET AUTHORIZATION LEVELS FOR THIS RESOURCE
      assign resource_required_levels = blank

      # TRY AS SINGLE METAOBJECT
      if resource_auth_metaobject.level
        assign level_value = resource_auth_metaobject.level
        if level_value != blank
          assign resource_required_levels = level_value | downcase | split: ','
        endif
      else
        # TRY AS ARRAY OF METAOBJECTS
        assign temp_levels = blank
        for auth_obj in resource_auth_metaobject
          if auth_obj.level
            assign level_value = auth_obj.level
            if level_value != blank
              if temp_levels == blank
                assign temp_levels = level_value
              else
                assign temp_levels = temp_levels | append: ',' | append: level_value
              endif
            endif
          endif
        endfor
        if temp_levels != blank
          assign resource_required_levels = temp_levels | downcase | split: ','
        endif
      endif

      # CHECK IF CUSTOMER HAS MATCHING AUTHORIZATION
      if customer_authorization_level != blank and resource_required_levels != blank
        for required_level in resource_required_levels
          assign required_level_clean = required_level | strip
          if customer_authorization_level == required_level_clean
            assign resource_authorized = true
            break
          endif
        endfor
      endif
    else
      # NO AUTHORIZATION REQUIRED - PUBLIC RESOURCE
      assign resource_authorized = true
    endif

    # ADD TO AUTHORIZED RESOURCES ARRAY
    if resource_authorized
      if authorized_resources == blank
        assign authorized_resources = resource | concat: blank
      else
        assign authorized_resources = authorized_resources | concat: resource | concat: blank
      endif
    endif
  endfor

  # USE AUTHORIZED RESOURCES FOR DISPLAY
  assign video_resources = authorized_resources
-%}

<pre>
  With Authorization Text v032
  {{ video_resources.count | prepend: 'Video resources count: ' }}
</pre>

{%- if video_resources.count > 0 -%}
  <div class="ethossence-video-resources section-{{ section.id }}-padding">
    <div class="ethossence-video-resources__wrapper page-width">

      {%- if section.settings.heading != blank -%}
        <h2 class="ethossence-video-resources__heading {{ section.settings.heading_size }}">
          {{ section.settings.heading }}
        </h2>
      {%- endif -%}

      <div class="ethossence-video-resources__grid grid grid--{{ section.settings.columns_desktop }}-col-desktop grid--{{ section.settings.columns_mobile }}-col-tablet-down">
        {%- for resource in video_resources -%}
          {%- liquid
            assign resource_title = resource.title.value
            assign resource_description = resource.description | metafield_tag
            assign resource_file = resource.file.value
            assign resource_url = resource.url.value

            # DETERMINE IF WE HAVE A VIDEO TO DISPLAY
            assign has_video = false
            if resource_file != blank or resource_url != blank
              assign has_video = true
            endif
          -%}

          <div class="ethossence-video-resources__item">
            {%- if has_video -%}
              <div class="ethossence-video-resources__video-wrapper">
                {%- if resource_file != blank -%}
                  {%- comment %} SHOPIFY CDN VIDEO FILE {% endcomment -%}
                  {%- if resource_file.media_type == 'video' -%}
                    <video-section class="ethossence-video-resources__video-section">
                      <deferred-media class="ethossence-video-resources__deferred-media" data-media-id="{{ resource_file.id }}">
                        <button
                          id="Deferred-Poster-Modal-{{ resource_file.id }}"
                          class="ethossence-video-resources__poster"
                          type="button"
                          aria-label="Play video"
                        >
                          {%- if resource_file.preview_image != blank -%}
                            <img
                              src="{{ resource_file.preview_image | image_url: width: 1920 }}"
                              srcset="
                                {%- if resource_file.preview_image.width >= 375 -%}{{ resource_file.preview_image | image_url: width: 375 }} 375w,{%- endif -%}
                                {%- if resource_file.preview_image.width >= 750 -%}{{ resource_file.preview_image | image_url: width: 750 }} 750w,{%- endif -%}
                                {%- if resource_file.preview_image.width >= 1100 -%}{{ resource_file.preview_image | image_url: width: 1100 }} 1100w,{%- endif -%}
                                {%- if resource_file.preview_image.width >= 1500 -%}{{ resource_file.preview_image | image_url: width: 1500 }} 1500w,{%- endif -%}
                                {%- if resource_file.preview_image.width >= 1780 -%}{{ resource_file.preview_image | image_url: width: 1780 }} 1780w,{%- endif -%}
                                {%- if resource_file.preview_image.width >= 2000 -%}{{ resource_file.preview_image | image_url: width: 2000 }} 2000w,{%- endif -%}
                                {%- if resource_file.preview_image.width >= 3000 -%}{{ resource_file.preview_image | image_url: width: 3000 }} 3000w,{%- endif -%}
                                {%- if resource_file.preview_image.width >= 3840 -%}{{ resource_file.preview_image | image_url: width: 3840 }} 3840w,{%- endif -%}
                                {{ resource_file.preview_image | image_url }} {{ resource_file.preview_image.width }}w
                              "
                              sizes="(min-width: {{ settings.page_width }}px) {{ settings.page_width | minus: 100 }}px, (min-width: 750px) calc(100vw - 10rem), 100vw"
                              alt="{{ resource_file.alt | escape }}"
                              loading="lazy"
                              width="{{ resource_file.preview_image.width }}"
                              height="{{ resource_file.preview_image.height }}"
                            >
                          {%- endif -%}
                          <span class="ethossence-video-resources__play-button">
                            <svg aria-hidden="true" focusable="false" class="icon icon-play" viewBox="0 0 18 18">
                              <path d="M4.75 2.84a.75.75 0 0 0-1.125.65v11.02a.75.75 0 0 0 1.125.65l9.574-5.51a.75.75 0 0 0 0-1.3L4.75 2.84Z" />
                            </svg>
                          </span>
                        </button>
                        <template>
                          {{ resource_file | media_tag: controls: true, preload: 'metadata' }}
                        </template>
                      </deferred-media>
                    </video-section>
                  {%- endif -%}

                {%- elsif resource_url != blank -%}
                  {%- comment %} EXTERNAL VIDEO URL (YOUTUBE/VIMEO) {% endcomment -%}
                  {%- liquid
                    # EXTRACT VIDEO ID AND DETERMINE PLATFORM
                    assign s_vid_url_no_params = resource_url | split: '?'
                    assign vid_id = ''
                    assign vid_platform = ''
                    assign vid_url_after_q = ''
                    
                    for vid_no_params in s_vid_url_no_params
                      if forloop.first
                        assign s_vid_url_parts = vid_no_params | split: '/'
                        for vid_part in s_vid_url_parts
                          if forloop.last
                            assign vid_id = vid_part
                          endif
                        endfor
                        
                        # DETERMINE PLATFORM
                        if vid_no_params contains 'vimeo'
                          assign vid_platform = 'vimeo'
                        elsif vid_no_params contains 'youtube' or vid_no_params contains 'youtu.be'
                          assign vid_platform = 'youtube'
                        endif
                      elsif forloop.last
                        assign vid_url_after_q = vid_no_params
                      endif
                    endfor
                    
                    # BUILD EMBED URL
                    if vid_platform == 'vimeo'
                      assign embed_url = 'https://player.vimeo.com/video/' | append: vid_id | append: '?title=false&byline=false&portrait=false&color=#000000'
                    elsif vid_platform == 'youtube'
                      assign embed_url = 'https://www.youtube.com/embed/' | append: vid_id | append: '?rel=0'
                    endif
                  -%}

                  {%- if vid_id != blank and vid_platform != blank -%}
                    {%- if section.settings.lazy_load -%}
                      <div class="ethossence-video-resources__placeholder" data-video-platform="{{ vid_platform }}" data-video-id="{{ vid_id }}" data-embed-url="{{ embed_url }}">
                        <button type="button" class="ethossence-video-resources__play-button-overlay" aria-label="Play video">
                          <svg aria-hidden="true" focusable="false" width="72" height="72" viewBox="0 0 72 72">
                            <circle cx="36" cy="36" r="34" fill="rgba(0,0,0,0.6)"/>
                            <path d="M28 48.5V23.5L52 36L28 48.5Z" fill="white"/>
                          </svg>
                        </button>
                        {%- if vid_platform == 'youtube' -%}
                          <img 
                            src="https://img.youtube.com/vi/{{ vid_id }}/hqdefault.jpg" 
                            alt="{{ resource_title | escape }}"
                            loading="lazy"
                            width="480"
                            height="360"
                          >
                        {%- elsif vid_platform == 'vimeo' -%}
                          <div class="ethossence-video-resources__vimeo-thumbnail" data-vimeo-id="{{ vid_id }}"></div>
                        {%- endif -%}
                      </div>
                    {%- else -%}
                      <iframe
                        src="{{ embed_url }}"
                        frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen
                        loading="lazy"
                        class="ethossence-video-resources__iframe"
                      ></iframe>
                    {%- endif -%}
                  {%- endif -%}
                {%- endif -%}
              </div>
            {%- endif -%}

            <div class="ethossence-video-resources__content">
              {%- if resource_title != blank and section.settings.include_video_title -%}
                {{ section.settings.title_size | prepend: '<' | append: '>' }}
                  {{ resource_title }}
                {{ section.settings.title_size | prepend: '</' | append: '>' }}
              {%- endif -%}

              {%- if resource_description != blank and section.settings.include_video_description -%}
                <div class="ethossence-video-resources__description rte">
                  {{ resource_description }}
                </div>
              {%- endif -%}

            </div>
          </div>
        {%- endfor -%}
      </div>
    </div>
  </div>
{%- endif -%}

{% schema %}
{
  "name": "Video resources",
  "tag": "section",
  "class": "section",
  "disabled_on": {
    "groups": ["header", "footer"]
  },
  "settings": [
    {
      "type": "header",
      "content": "Header"
    },       
    {
      "type": "inline_richtext",
      "id": "heading",
      "label": "Heading",
      "default": "Video resources"
    },
    {
      "type": "select",
      "id": "heading_size",
      "options": [
        {
          "value": "h2",
          "label": "t:sections.all.heading_size.options__1.label"
        },
        {
          "value": "h1",
          "label": "t:sections.all.heading_size.options__2.label"
        },
        {
          "value": "h0",
          "label": "t:sections.all.heading_size.options__3.label"
        },
        {
          "value": "hxl",
          "label": "t:sections.all.heading_size.options__4.label"
        },
        {
          "value": "hxxl",
          "label": "t:sections.all.heading_size.options__5.label"
        }
      ],
      "default": "h2",
      "label": "Heading size"
    },
    {
      "type": "header",
      "content": "Video content"
    },   
    {
      "type": "checkbox",
      "id": "include_video_title",
      "label": "Include video title",
      "default": true
    }, 
    {
      "type": "select",
      "id": "title_size",
      "options": [
        {
          "value": "h2",
          "label": "Header 2"
        },
        {
          "value": "h3",
          "label": "Header 3"
        },
        {
          "value": "h4",
          "label": "Header 4"
        },
        {
          "value": "h5",
          "label": "Header 5"
        },
        {
          "value": "span",
          "label": "Regular"
        }
      ],
      "default": "h3",      
      "label": "Video title size"
    },
    {
      "type": "checkbox",
      "id": "include_video_description",
      "label": "Include video description",
      "default": true
    },
    {
      "type": "header",
      "content": "Display settings"
    },       
    {
      "type": "range",
      "id": "columns_desktop",
      "min": 1,
      "max": 4,
      "step": 1,
      "default": 2,
      "label": "Number of columns on desktop"
    },
    {
      "type": "select",
      "id": "columns_mobile",
      "options": [
        {
          "value": "1",
          "label": "1 column"
        },
        {
          "value": "2",
          "label": "2 columns"
        }
      ],
      "default": "1",
      "label": "Number of columns on mobile"
    },
    {
      "type": "checkbox",
      "id": "lazy_load",
      "label": "Enable lazy loading for external videos",
      "info": "Shows YouTube/Vimeo thumbnails with play buttons. Videos load when clicked.",
      "default": true
    },
    {
      "type": "header",
      "content": "t:sections.all.padding.section_padding_heading"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "t:sections.all.padding.padding_top",
      "default": 28
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "t:sections.all.padding.padding_bottom",
      "default": 28
    }
  ],
  "presets": [
    {
      "name": "Video resources",
      "category": "Ethossence"
    }
  ]
}
{% endschema %}