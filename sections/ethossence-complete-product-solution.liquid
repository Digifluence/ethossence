{%- comment -%}
  ETHOSSENCE COMPLETE PRODUCT SOLUTION SECTION

  Displays complete system solutions for products.
  Only renders if the current product is in the metaobject's core_product list.

  Metafield: ethossence.solutions_complete (single metaobject reference)
  Metaobject type: solutions_complete
  Fields:
    - group_heading (single line text)
    - group_note (multi-line text)
    - group_required_choice (boolean)
    - core_product (list product)
    - complete_system_product_variants (list product variant)
{%- endcomment -%}

{%- liquid
  # Get the solutions_complete metaobject from the product
  assign solution = product.metafields.ethossence.solutions_complete.value

  # Check if current product is in the core_product list
  assign show_section = false

  if solution != blank
    assign core_products = solution.core_product.value
    if core_products != blank
      for core_product in core_products
        if core_product.id == product.id
          assign show_section = true
          break
        endif
      endfor
    endif
  endif
-%}

{%- if show_section -%}
  {{ 'ethossence-complete-product-solution.css' | asset_url | stylesheet_tag }}

  {%- style -%}
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
      padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
    }

    @media screen and (min-width: 750px) {
      .section-{{ section.id }}-padding {
        padding-top: {{ section.settings.padding_top }}px;
        padding-bottom: {{ section.settings.padding_bottom }}px;
      }
    }
  {%- endstyle -%}

  <div class="section-{{ section.id }}-padding color-{{ section.settings.color_scheme }} gradient">
    <div class="page-width">
      <div class="complete-solution">

        {%- comment -%} Section Heading {%- endcomment -%}
        {%- if section.settings.heading != blank -%}
          <h2 class="complete-solution__section-heading {{ section.settings.heading_size }}">
            {{ section.settings.heading }}
          </h2>
        {%- endif -%}

        {%- comment -%} Group Heading {%- endcomment -%}
        {%- if solution.group_heading != blank -%}
          <div class="complete-solution__header">
            <h3 class="complete-solution__group-heading">
              {{ solution.group_heading }}
              {%- if solution.group_required_choice -%}
                <span class="complete-solution__required-badge">Required</span>
              {%- endif -%}
            </h3>
          </div>
        {%- endif -%}

        {%- comment -%} Group Note {%- endcomment -%}
        {%- if solution.group_note != blank -%}
          <div class="complete-solution__note rte">
            {{ solution.group_note }}
          </div>
        {%- endif -%}

        {%- comment -%} Product Variants List {%- endcomment -%}
        {%- assign variants = solution.complete_system_product_variants.value -%}
        {%- if variants != blank and variants.size > 0 -%}
          <div class="complete-solution__variants-list">
            {%- for variant in variants -%}
              {%- assign variant_product = variant.product -%}
              <div class="complete-solution__variant-item">

                {%- comment -%} Variant Image {%- endcomment -%}
                <div class="complete-solution__variant-image">
                  {%- if variant.image != blank -%}
                    {{ variant.image | image_url: width: 300 | image_tag:
                      loading: 'lazy',
                      widths: '150, 300, 450',
                      sizes: '(min-width: 750px) 200px, 150px',
                      alt: variant.title
                    }}
                  {%- elsif variant_product.featured_image != blank -%}
                    {{ variant_product.featured_image | image_url: width: 300 | image_tag:
                      loading: 'lazy',
                      widths: '150, 300, 450',
                      sizes: '(min-width: 750px) 200px, 150px',
                      alt: variant_product.title
                    }}
                  {%- else -%}
                    <div class="complete-solution__no-image">
                      {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
                    </div>
                  {%- endif -%}
                </div>

                {%- comment -%} Variant Details {%- endcomment -%}
                <div class="complete-solution__variant-details">
                  <h4 class="complete-solution__variant-title">
                    <a href="{{ variant_product.url }}">
                      {{ variant_product.title }}
                    </a>
                  </h4>

                  {%- if variant.title != 'Default Title' -%}
                    <p class="complete-solution__variant-options">
                      {{ variant.title }}
                    </p>
                  {%- endif -%}

                  {%- if variant.sku != blank -%}
                    <p class="complete-solution__variant-sku">
                      SKU: {{ variant.sku }}
                    </p>
                  {%- endif -%}
                </div>

                {%- comment -%} Variant Price {%- endcomment -%}
                <div class="complete-solution__variant-price">
                  {%- if variant.compare_at_price > variant.price -%}
                    <span class="complete-solution__price--sale">
                      {{ variant.price | money }}
                    </span>
                    <span class="complete-solution__price--compare">
                      <s>{{ variant.compare_at_price | money }}</s>
                    </span>
                  {%- else -%}
                    <span class="complete-solution__price">
                      {{ variant.price | money }}
                    </span>
                  {%- endif -%}
                </div>

                {%- comment -%} Add to Cart {%- endcomment -%}
                <div class="complete-solution__variant-action">
                  {%- if variant.available -%}
                    <form method="post" action="/cart/add" class="complete-solution__form">
                      <input type="hidden" name="id" value="{{ variant.id }}">
                      <input type="hidden" name="quantity" value="1">
                      <button type="submit" class="button complete-solution__add-btn">
                        {{ 'products.product.add_to_cart' | t }}
                      </button>
                    </form>
                  {%- else -%}
                    <button type="button" class="button complete-solution__add-btn" disabled>
                      {{ 'products.product.sold_out' | t }}
                    </button>
                  {%- endif -%}
                </div>

              </div>
            {%- endfor -%}
          </div>
        {%- endif -%}

      </div>
    </div>
  </div>
{%- endif -%}

{% schema %}
{
  "name": "Complete Solution",
  "tag": "section",
  "class": "section",
  "enabled_on": {
    "templates": ["product"]
  },
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Section heading",
      "default": "Complete Your System"
    },
    {
      "type": "select",
      "id": "heading_size",
      "label": "Heading size",
      "options": [
        { "value": "h2", "label": "Small" },
        { "value": "h1", "label": "Medium" },
        { "value": "h0", "label": "Large" }
      ],
      "default": "h1"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:sections.all.colors.label",
      "default": "scheme-1"
    },
    {
      "type": "header",
      "content": "Section padding"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "t:sections.all.padding.padding_top",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "t:sections.all.padding.padding_bottom",
      "default": 36
    }
  ],
  "presets": [
    {
      "name": "Complete Solution"
    }
  ]
}
{% endschema %}
