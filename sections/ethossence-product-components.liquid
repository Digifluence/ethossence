{%- comment -%}
  ETHOSSENCE Product Components Section
  

{%- endcomment -%}

{{ 'component-price.css' | asset_url | stylesheet_tag }}
{{ 'quick-order-list.css' | asset_url | stylesheet_tag }}
{{ 'quantity-popover.css' | asset_url | stylesheet_tag }}

{%  style  %}
    /* Ethossence override for product components */
    @media screen and (min-width: 990px) {
        #shopify-section-{{ section.id }} .quick-order-list__table thead th:first-child,
        #shopify-section-{{ section.id }} .quick-order-list-total__column {
            width: 50%;
        }
    }

    #shopify-section-{{ section.id }} .quick-order-list-buttons {
        text-align: center;
    }

    #shopify-section-{{ section.id }} .variant-item__link,
    #shopify-section-{{ section.id }} .variant-item__link:visited {
        color: rgb(var(--color-link-primary));
    }

    #shopify-section-{{ section.id }} .variant-item__link:hover {
        color: rgba(var(--color-link-primary), 0.8);
    }
{% endstyle %}

<script src="{{ 'quantity-popover.js' | asset_url }}" defer="defer"></script>
<script src="{{ 'price-per-item.js' | asset_url }}" defer="defer"></script>
<script src="{{ 'quick-order-list.js' | asset_url }}" defer="defer"></script>

<script>
  // Add visual confirmation when products are added to cart from ethossence-product-components
  (function() {
    let isSetup = false;
    const sectionId = '{{ section.id }}-{{ product.id }}';

    function setupCartVisualConfirmation() {
      if (isSetup) return; // Only setup once

      // Check for cart drawer or cart notification
      const cartDrawer = document.querySelector('cart-drawer');
      const cartNotification = document.querySelector('cart-notification');

      if (!cartDrawer && !cartNotification) {
        // Don't log error - cart type might be 'page' which is valid
        return;
      }

      if (typeof subscribe === 'undefined' || typeof PUB_SUB_EVENTS === 'undefined') {
        // PubSub not ready yet, will try again on next event
        return;
      }

      isSetup = true;
      const cartType = cartDrawer ? 'drawer' : 'notification';
      console.log('Setting up cart', cartType, 'confirmation for section:', sectionId);

      subscribe(PUB_SUB_EVENTS.cartUpdate, (event) => {
        console.log('Cart update event received:', event);
        console.log('Expected source:', sectionId);
        console.log('Actual source:', event.source);

        // Only respond to cart updates from this section
        if (event.source && event.source === sectionId) {
          console.log('Source matched! Opening cart', cartType + '...');

          // Hide the section message (cart notification is sufficient)
          const quickOrderList = document.getElementById(sectionId);
          if (quickOrderList) {
            const messages = quickOrderList.querySelectorAll('.quick-order-list__message-text');
            const icons = quickOrderList.querySelectorAll('.quick-order-list__message-icon');

            messages.forEach((msg) => {
              msg.innerHTML = '';
            });

            // Hide the checkmark icon
            icons.forEach((icon) => icon.classList.add('hidden'));
          }

          setTimeout(() => {
            if (cartType === 'drawer') {
              const drawer = document.querySelector('cart-drawer');
              if (drawer && typeof drawer.open === 'function') {
                drawer.open();

                // Update the cart drawer's internal message after it opens
                setTimeout(() => {
                  // Try multiple possible selectors for the message
                  const possibleSelectors = [
                    '.product-added-message',
                    '[role="status"]',
                    '.cart-drawer__message',
                    '.cart__message',
                    '*[class*="message"]'
                  ];

                  possibleSelectors.forEach(selector => {
                    const messages = drawer.querySelectorAll(selector);
                    messages.forEach((msg) => {
                      const text = msg.textContent || msg.innerText;
                      if (text && (text.includes('added') || text.includes('removed') || text.includes('Item'))) {
                        console.log('Found message element:', selector, 'with text:', text);
                        msg.textContent = 'Your cart has been updated';
                      }
                    });
                  });
                }, 150);
              }
            } else {
              const notification = document.querySelector('cart-notification');
              if (notification && typeof notification.open === 'function') {
                notification.open();

                // Update the notification heading message
                setTimeout(() => {
                  const heading = notification.querySelector('.cart-notification__heading');
                  if (heading) {
                    // Get the SVG icon (first child)
                    const icon = heading.querySelector('.svg-wrapper');
                    // Replace text content while preserving the icon
                    if (icon) {
                      heading.innerHTML = icon.outerHTML + ' Your cart has been updated';
                    } else {
                      heading.textContent = 'Your cart has been updated';
                    }
                    console.log('Updated cart notification heading to: Your cart has been updated');
                  }
                }, 150);
              }
            }
          }, 100);
        }
      });
    }

    // Try to setup at multiple points
    if (document.readyState !== 'loading') {
      setupCartVisualConfirmation();
    }
    document.addEventListener('DOMContentLoaded', setupCartVisualConfirmation);
    window.addEventListener('load', setupCartVisualConfirmation);
  })();
</script>

{%- style -%}
  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
  }

  @media screen and (min-width: 750px) {
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    }
  }

  .product-components__header {
    margin-bottom: 0 !important;
  }

  .product-components__heading {
    margin: 0 0 1rem 0;
  }

  .product-components__description {
    margin: 0;
  }
{%- endstyle -%}

<div class="page-width section-{{ section.id }}-padding color-{{ section.settings.color_scheme }} gradient">

   {%- if section.settings.heading != blank or section.settings.description != blank -%}
      <div class="product-components__header">
      {%- if section.settings.heading != blank -%}
         <h2 class="product-components__heading {{ section.settings.heading_size }}">
            {{ section.settings.heading }}
         </h2>
      {%- endif -%}
      {%- if section.settings.description != blank -%}
         <div class="product-components__description rte">
            {{ section.settings.description }}
         </div>
      {%- endif -%}
      </div>
   {%- endif -%}

   {% render 'ethossence-product-components-list',
      product: product,
      collection: section.settings.collection,
      show_image: section.settings.show_image,
      show_sku: section.settings.show_sku,
      show_vendor: section.settings.show_vendor
   %}

</div>

{% schema %}
{
  "name": "List of variantst",
  "limit": 1,
  "enabled_on": {
    "templates": ["product"]
  },
  "settings": [
    {
      "type": "inline_richtext",
      "id": "heading",
      "label": "Heading",
      "default": "Product Components"
    },
    {
      "type": "select",
      "id": "heading_size",
      "options": [
        {
          "value": "h2",
          "label": "t:sections.all.heading_size.options__1.label"
        },
        {
          "value": "h1",
          "label": "t:sections.all.heading_size.options__2.label"
        },
        {
          "value": "h0",
          "label": "t:sections.all.heading_size.options__3.label"
        }
      ],
      "default": "h1",
      "label": "t:sections.all.heading_size.label"
    },
    {
      "type": "richtext",
      "id": "description",
      "label": "Description"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection"
    },
    {
      "type": "range",
      "id": "variants_per_page",
      "min": 5,
      "max": 50,
      "step": 1,
      "default": 50,
      "label": "t:sections.quick-order-list.settings.variants_per_page.label"
    },
    {
      "type": "checkbox",
      "id": "show_image",
      "default": false,
      "label": "t:sections.quick-order-list.settings.show_image.label"
    },
    {
      "type": "checkbox",
      "id": "show_sku",
      "default": false,
      "label": "t:sections.quick-order-list.settings.show_sku.label"
    },
    {
      "type": "checkbox",
      "id": "show_vendor",
      "default": false,
      "label": "Show vendor"
    },    
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:sections.all.colors.label",
      "default": "scheme-1"
    },
    {
      "type": "header",
      "content": "t:sections.all.padding.section_padding_heading"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "t:sections.all.padding.padding_top",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "t:sections.all.padding.padding_bottom",
      "default": 36
    }
  ],
  "presets": [
    {
      "name": "List of variants",
      "category": "Ethossence - products"
    }
  ]
}
{% endschema %}
