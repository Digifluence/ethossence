{% comment %}
  Renders a media gallery of images and/or videos. 

  Accepts:


  Usage:
  {% render 'ethossence-media-gallery' %}
{% endcomment %}


{%- liquid

  assign gallery_items = product.metafields.ethossence.image_gallery_file.value
  
  assign media_count = 0 
  
  for media in gallery_items
    assign media_count = media_count | plus: 1 
  endfor

  if media_count == 1 
    assign single_media_visible_mobile = true
  endif

  if media_count == 0 or single_media_visible_mobile or section.settings.mobile_thumbnails == 'show' or section.settings.mobile_thumbnails == 'columns' and media_count < 3
    assign hide_mobile_slider = true
  endif

  if media_count > 0
    assign media_width = 1100
  else
    assign media_width = 0
  endif

  assign first_3d_model = false
  assign single_media_visible = false
  assign enable_video_looping = false
  assign media_type = 'image'

-%}


{% if section.settings.image_zoom == 'hover' %}
  <script id="EnableZoomOnHover-main" src="{{ 'magnify.js' | asset_url }}" defer="defer"></script>
{% endif %}

{{ 'component-slider.css' | asset_url | stylesheet_tag }}
{{ 'component-deferred-media.css' | asset_url | stylesheet_tag }}

{%- style -%}
    
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
      padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
    }
  
    @media screen and (min-width: 750px) {
      .section-{{ section.id }}-padding {
        padding-top: {{ section.settings.padding_top }}px;
        padding-bottom: {{ section.settings.padding_bottom }}px;
      }
    }

    .product--columns, .product--columns .product__media-item:not(.product__media-item--single):not(:only-child) {
      max-width: 100%;
    }

{%- endstyle -%}

{%- if media_type == 'model' -%}
  {%- for media in gallery_items -%}
    {%- assign first_3d_model = media | where: 'media_type', 'model' | first -%}
    {%- if first_3d_model -%}
      {{ 'component-product-model.css' | asset_url | stylesheet_tag }}
      <link
        id="ModelViewerStyle"
        rel="stylesheet"
        href="https://cdn.shopify.com/shopifycloud/model-viewer-ui/assets/v1.0/model-viewer-ui.css"
        media="print"
        onload="this.media='all'"
      >
      <link
        id="ModelViewerOverride"
        rel="stylesheet"
        href="{{ 'component-model-viewer-ui.css' | asset_url }}"
        media="print"
        onload="this.media='all'"
      >
    {%- endif -%}
  {%- endfor -%}
{%- endif -%}

<ethossence-media-gallery {% if section.settings.image_zoom == 'hover' %}data-zoom-on-hover {% endif %}>

  <div class="page-width color-{{ section.settings.color_scheme }} gradient section-{{ section.id }}-padding">
    <div class="product product--{{ section.settings.gallery_layout }} product--mobile-{{ section.settings.mobile_thumbnails }} grid grid--1-col {% if media_count > 0 %}grid--{{ section.settings.layout_items_per_row }}-col-tablet{% else %}product--no-media{% endif %}">
      <div class="grid__item">  

        <media-gallery 
          id="MediaGallery-{{ section.id }}" 
          role="region" 
          aria-label="media gallery" 
          data-desktop-layout="{{ section.settings.gallery_layout }}
        ">

          <div id="GalleryStatus-{{ section.id }}" class="visually-hidden" role="status"></div>
          
          <slider-component id="GalleryViewer-{{ section.id }}" class="slider-mobile-gutter">

            <ul
              id="Slider-Gallery-{{ section.id }}"
              class="product__media-list contains-media grid grid--peek list-unstyled slider slider--mobile"
              role="list"
            >
              {%- for media in gallery_items -%}
                  <li
                    id="Slide-{{ section.id }}-{{ media.id }}"
                    class="product__media-item grid__item slider__slide 
                      {% if forloop.first %}is-active{% endif %}
                      {% if single_media_visible %} product__media-item--single{% endif %}
                      {% if media.media_type != 'image' %} product__media-item--full{% endif %}
                      {% if settings.animations_reveal_on_scroll %} scroll-trigger animate--fade-in{% endif %}
                    "
                    data-media-id="{{ section.id }}-{{ media.id }}"
                  >
                    {% render 'ethossence-media-gallery-thumbnail',
                      modal_id: section.id,
                      position: forloop.index,
                      media: media,
                      media_count: media_count,
                      media_width: media_width,
                      media_fit: section.settings.media_fit,
                      desktop_layout: section.settings.gallery_layout,
                      mobile_layout: section.settings.mobile_thumbnails,
                      loop: enable_video_looping,
                      lazy_load: true
                    %}
                  </li>                 

              {%- endfor -%}
            </ul>

            <div class="slider-buttons quick-add-hidden{% if hide_mobile_slider %} small-hide{% endif %}">

              <button
                type="button"
                class="slider-button slider-button--prev"
                name="previous"
                aria-label="{{ 'general.slider.previous_slide' | t }}"
              >
                <span class="svg-wrapper">{{- 'icon-caret.svg' | inline_asset_content -}}</span>
              </button>
              
              <div class="slider-counter caption">
                <span class="slider-counter--current">1</span>
                <span aria-hidden="true"> / </span>
                <span class="visually-hidden">{{ 'general.slider.of' | t }}</span>
                <span class="slider-counter--total">{{ media_count }}</span>
              </div>
              
              <button
                type="button"
                class="slider-button slider-button--next"
                name="next"
                aria-label="{{ 'general.slider.next_slide' | t }}"
              >
                <span class="svg-wrapper">{{- 'icon-caret.svg' | inline_asset_content -}}</span>
              </button>

            </div>    
          </slider-component>

          {%- 
            if media_count > 1 
            and section.settings.gallery_layout contains 'thumbnail' 
            or section.settings.mobile_thumbnails == 'show' 
          -%}  

            <slider-component
              id="GalleryThumbnails-{{ section.id }}"
              class="ethossence-thumbnail-slider thumbnail-slider slider-mobile-gutter quick-add-hidden{% unless section.settings.gallery_layout contains 'thumbnail' %} medium-hide large-up-hide{% endunless %}{% if section.settings.mobile_thumbnails != 'show' %} small-hide{% endif %}{% if media_count <= 3 %} thumbnail-slider--no-slide{% endif %}"
            >
              
              <button
                type="button"
                class="slider-button slider-button--prev{% if media_count <= 3 %} small-hide{% endif %}{% if media_count <= 4 %} medium-hide large-up-hide{% endif %}"
                name="previous"
                aria-label="{{ 'general.slider.previous_slide' | t }}"
                aria-controls="GalleryThumbnails-{{ section.id }}"
                data-step="3"
              >
                <span class="svg-wrapper">{{- 'icon-caret.svg' | inline_asset_content -}}</span>
              </button>

              <ul
                id="Slider-Thumbnails-{{ section.id }}"
                class="thumbnail-list list-unstyled slider slider--mobile{% if section.settings.gallery_layout == 'thumbnail_slider' %} slider--tablet-up{% endif %}"
              >
                {%- capture sizes -%}
                  (min-width: {{ settings.page_width }}px) calc(({{ settings.page_width | minus: 100 | times: media_width | round }} - 4rem) / 4),
                  (min-width: 990px) calc(({{ media_width | times: 100 }}vw - 4rem) / 4),
                  (min-width: 750px) calc((100vw - 15rem) / 8),
                  calc((100vw - 8rem) / 3)
                {%- endcapture -%}

                {% for media in gallery_items %}
                  
                    {%- liquid
                      capture media_index
                        if media.media_type == 'model'
                          increment model_index
                        elsif media.media_type == 'video' or media.media_type == 'external_video'
                          increment video_index
                        elsif media.media_type == 'image'
                          increment image_index
                        endif
                      endcapture
                      assign media_index = media_index | plus: 1
                    -%}

                    <li
                      id="Slide-Thumbnails-{{ section.id }}-{{ forloop.index }}"
                      class="ethossence-thumbnail thumbnail-list__item slider__slide"
                      data-target="{{ section.id }}-{{ media.id }}"
                      data-media-position="{{ media_index }}"
                    >
                      {%- if media.media_type == 'model' -%}
                        <span class="thumbnail__badge" aria-hidden="true"><span class="svg-wrapper">{{- 'icon-3d-model.svg' | inline_asset_content -}}</span></span>
                      {%- elsif media.media_type == 'video' or media.media_type == 'external_video' -%}
                        <span class="thumbnail__badge" aria-hidden="true"><span class="svg-wrapper">{{- 'icon-play.svg' | inline_asset_content -}}</span></span>
                      {%- endif -%}

                      {%- capture thumbnail_id -%}
                        Thumbnail-{{ section.id }}-{{ forloop.index }}
                      {%- endcapture -%}
                      
                      <button
                        class="thumbnail global-media-settings global-media-settings--no-shadow"
                        aria-label="{%- if media.media_type == 'image' -%}{{ 'products.product.media.load_image' | t: index: media_index }}{%- elsif media.media_type == 'model' -%}{{ 'products.product.media.load_model' | t: index: media_index }}{%- elsif media.media_type == 'video' or media.media_type == 'external_video' -%}{{ 'products.product.media.load_video' | t: index: media_index }}{%- endif -%}"
                        aria-current="true"
                        aria-controls="GalleryViewer-{{ section.id }}"
                        aria-describedby="{{ thumbnail_id }}"
                      >
                        {{
                          media.preview_image
                          | image_url: width: 416
                          | image_tag:
                            loading: 'lazy',
                            sizes: sizes,
                            widths: '54, 74, 104, 162, 208, 324, 416',
                            id: thumbnail_id,
                            alt: media.alt
                          | escape
                        }}
                      </button>
                    </li>
                  
                {%- endfor -%}
              </ul>

              <button
                type="button"
                class="slider-button slider-button--next{% if media_count <= 3 %} small-hide{% endif %}{% if media_count <= 4 %} medium-hide large-up-hide{% endif %}"
                name="next"
                aria-label="{{ 'general.slider.next_slide' | t }}"
                aria-controls="GalleryThumbnails-{{ section.id }}"
                data-step="3"
              >
                <span class="svg-wrapper">{{- 'icon-caret.svg' | inline_asset_content -}}</span>
              </button>

            </slider-component>

          {%- endif -%}

        </media-gallery>
        
      </div>
    </div>  
  </div>

  <product-modal id="ProductModal-{{ section.id }}" class="product-media-modal media-modal">
    <div
      class="product-media-modal__dialog color-{{ section.settings.color_scheme }} gradient"
      role="dialog"
      aria-label="gallery"
      aria-modal="true"
      tabindex="-1"
    >
      <button
        id="ModalClose-{{ section.id }}"
        type="button"
        class="product-media-modal__toggle"
        aria-label="{{ 'accessibility.close' | t }}"
      >
        {{ 'icon-close.svg' | inline_asset_content }}
      </button>
      <div
        class="product-media-modal__content color-{{ section.settings.color_scheme }} gradient"
        role="document"
        aria-label="gallery"
        tabindex="0"
      >
        {% for media in gallery_items %}
          {%- liquid render 'ethossence-media', media: media, loop: enable_video_looping, variant_image: false -%}
        {%- endfor -%}
      </div>
    </div>
  </product-modal>

  {%- if media_count > 0 -%}
    <script src="{{ 'media-gallery.js' | asset_url }}" defer="defer"></script>
    <script src="{{ 'ethossence-media-gallery-modal.js' | asset_url }}" defer="defer"></script>
  {%- endif -%}

  {%- if first_3d_model -%}
    <script type="application/json" id="ProductJSON-{{ product.id }}">
      {% for media in gallery_items %}
        {{ media | where: 'media_type', 'model' | json }}
      {% endfor %}}
    </script>
    <script src="{{ 'product-model.js' | asset_url }}" defer></script>
  {%- endif -%}

</ethossence-media-gallery>


{% schema %}
{
    "name": "Image gallery",
    "limit": 1,
    "enabled_on": {
        "templates": ["product"]
    },
    "settings": [   
        {
            "type": "color_scheme",
            "id": "color_scheme",
            "label": "t:sections.all.colors.label",
            "default": "scheme-1"
        },
        {
            "type": "header",
            "content": "t:sections.all.padding.section_padding_heading"
        },
        {
            "type": "range",
            "id": "padding_top",
            "min": 0,
            "max": 100,
            "step": 4,
            "unit": "px",
            "label": "t:sections.all.padding.padding_top",
            "default": 36
        },
        {
            "type": "range",
            "id": "padding_bottom",
            "min": 0,
            "max": 100,
            "step": 4,
            "unit": "px",
            "label": "t:sections.all.padding.padding_bottom",
            "default": 36
        },
        {
            "type": "header",
            "content": "t:sections.main-product.settings.header.content"
        },
        {
          "type": "select",
          "id": "media_fit",
          "options": [
            {
              "value": "contain",
              "label": "t:sections.main-product.settings.media_fit.options__1.label"
            },
            {
              "value": "cover",
              "label": "t:sections.main-product.settings.media_fit.options__2.label"
            }
          ],
          "default": "contain",
          "label": "t:sections.main-product.settings.media_fit.label"
        },        
        {
            "type": "select",
            "id": "gallery_layout",
            "options": [
                {
                "value": "columns",
                "label": "Columns"
                },
                {
                "value": "thumbnail",
                "label": "t:sections.main-product.settings.gallery_layout.options__3.label"
                },
                {
                "value": "thumbnail_slider",
                "label": "t:sections.main-product.settings.gallery_layout.options__4.label"
                }
            ],
            "default": "columns",
            "label": "t:sections.main-product.settings.gallery_layout.label"
        },
        {
            "type": "range",
            "id": "layout_items_per_row",
            "min": 1,
            "max": 6,
            "step": 1,
            "default": 3,
            "label": "If layout is columns, items per row"
        },          
        {
            "type": "select",
            "id": "mobile_thumbnails",
            "options": [
                {
                "value": "columns",
                "label": "Columns"
                },
                {
                "value": "show",
                "label": "t:sections.main-product.settings.mobile_thumbnails.options__2.label"
                },
                {
                "value": "hide",
                "label": "t:sections.main-product.settings.mobile_thumbnails.options__3.label"
                }
            ],
            "default": "hide",
            "label": "t:sections.main-product.settings.mobile_thumbnails.label"
        },               
        {
            "type": "select",
            "id": "image_zoom",
            "options": [
                {
                "value": "lightbox",
                "label": "t:sections.main-product.settings.image_zoom.options__1.label"
                },
                {
                "value": "hover",
                "label": "t:sections.main-product.settings.image_zoom.options__2.label"
                },
                {
                "value": "none",
                "label": "t:sections.main-product.settings.image_zoom.options__3.label"
                }
            ],
            "default": "lightbox",
            "label": "t:sections.main-product.settings.image_zoom.label"
        }
    ],
    "presets": [
        {
            "name": "Image gallery",
            "category": "Media"
        }
    ]
}
{% endschema %}