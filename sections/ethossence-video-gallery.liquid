{{ 'ethossence-video-gallery.css' | asset_url | stylesheet_tag }}
<script src="{{ 'ethossence-video-gallery.js' | asset_url }}" defer="defer"></script>

{%- liquid
  assign product_metafield = product.metafields.ethossence.collection_vid_gallery
  assign video_urls = product_metafield.value
-%}

<pre>
version 3
product.metafields.ethossence.collection_vid_gallery
{{ product.metafields.ethossence.collection_vid_gallery }}
video_urls: {{ video_urls }}
video_urls.size: {{ video_urls.size }}
</pre>

{%- if video_urls.size > 0 -%}
  <div class="ethossence-video-gallery page-width section-{{ section.id }}-padding">
    <div class="ethossence-video-gallery__wrapper">
      {%- if section.settings.heading != blank -%}
        <h2 class="ethossence-video-gallery__heading {{ section.settings.heading_size }}">
          {{ section.settings.heading }}
        </h2>
      {%- endif -%}

      <div class="ethossence-video-gallery__grid grid grid--{{ section.settings.columns_desktop }}-col-desktop grid--{{ section.settings.columns_mobile }}-col-tablet-down">
        {%- for vid_url in video_urls -%}
          {%- liquid
            # EXTRACT VIDEO ID AND DETERMINE PLATFORM
            assign s_vid_url_no_params = vid_url | split: '?'
            assign vid_id = ''
            assign vid_platform = ''
            assign vid_url_after_q = ''
            
            for vid_no_params in s_vid_url_no_params
              if forloop.first
                assign s_vid_url_parts = vid_no_params | split: '/'
                for vid_part in s_vid_url_parts
                  if forloop.last
                    assign vid_id = vid_part
                  endif
                endfor
                
                # DETERMINE PLATFORM
                if vid_no_params contains 'vimeo'
                  assign vid_platform = 'vimeo'
                elsif vid_no_params contains 'youtube' or vid_no_params contains 'youtu.be'
                  assign vid_platform = 'youtube'
                endif
              elsif forloop.last
                assign vid_url_after_q = vid_no_params
              endif
            endfor
            
            # BUILD EMBED URL
            if vid_platform == 'vimeo'
              assign embed_url = 'https://player.vimeo.com/video/' | append: vid_id | append: '?title=false&byline=false&portrait=false&color=' | append: section.settings.vimeo_color
            elsif vid_platform == 'youtube'
              assign embed_url = 'https://www.youtube.com/embed/' | append: vid_id | append: '?rel=0'
            endif
          -%}

          {%- if vid_id != blank and vid_platform != blank -%}
            <div class="ethossence-video-gallery__item">
              <div class="ethossence-video-gallery__video-wrapper">
                {%- if section.settings.lazy_load -%}
                  <div class="ethossence-video-gallery__placeholder" data-video-platform="{{ vid_platform }}" data-video-id="{{ vid_id }}" data-embed-url="{{ embed_url }}">
                    <button type="button" class="ethossence-video-gallery__play-button" aria-label="Play video">
                      <svg aria-hidden="true" focusable="false" width="72" height="72" viewBox="0 0 72 72">
                        <circle cx="36" cy="36" r="34" fill="rgba(0,0,0,0.6)"/>
                        <path d="M28 48.5V23.5L52 36L28 48.5Z" fill="white"/>
                      </svg>
                    </button>
                    {%- if vid_platform == 'youtube' -%}
                      <img 
                        src="https://img.youtube.com/vi/{{ vid_id }}/hqdefault.jpg" 
                        alt="video thumbnail"
                        loading="lazy"
                        width="480"
                        height="360"
                      >
                    {%- elsif vid_platform == 'vimeo' -%}
                      <div class="ethossence-video-gallery__vimeo-thumbnail" data-vimeo-id="{{ vid_id }}"></div>
                    {%- endif -%}
                  </div>
                {%- else -%}
                  <iframe
                    src="{{ embed_url }}"
                    frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen
                    loading="lazy"
                    class="ethossence-video-gallery__iframe"
                  ></iframe>
                {%- endif -%}
              </div>
            </div>
          {%- endif -%}
        {%- endfor -%}
      </div>
    </div>
  </div>
{%- endif -%}

{% schema %}
{
  "name": "Video gallery",
  "tag": "section",
  "class": "section",
  "disabled_on": {
    "groups": ["header", "footer"]
  },
  "settings": [
    {
      "type": "inline_richtext",
      "id": "heading",
      "label": "Heading",
      "default": "Video gallery"
    },
    {
      "type": "select",
      "id": "heading_size",
      "options": [
        {
          "value": "h2",
          "label": "Small"
        },
        {
          "value": "h1",
          "label": "Medium"
        },
        {
          "value": "h0",
          "label": "Large"
        }
      ],
      "default": "h1",
      "label": "Heading size"
    },
    {
      "type": "range",
      "id": "columns_desktop",
      "min": 1,
      "max": 4,
      "step": 1,
      "default": 3,
      "label": "Number of columns on desktop"
    },
    {
      "type": "select",
      "id": "columns_mobile",
      "options": [
        {
          "value": "1",
          "label": "1 column"
        },
        {
          "value": "2",
          "label": "2 columns"
        }
      ],
      "default": "1",
      "label": "Number of columns on mobile"
    },
    {
      "type": "checkbox",
      "id": "lazy_load",
      "label": "Enable lazy loading",
      "info": "Shows video thumbnails with play buttons. Videos load when clicked.",
      "default": true
    },
    {
      "type": "color",
      "id": "vimeo_color",
      "label": "Vimeo player color",
      "default": "#00adef"
    },
    {
      "type": "header",
      "content": "Section padding"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Top padding",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Bottom padding",
      "default": 36
    }
  ],
  "presets": [
    {
      "name": "Video gallery",
      "category": "Ethossence"
    }
  ]
}
{% endschema %}
