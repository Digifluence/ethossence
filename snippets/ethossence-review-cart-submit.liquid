<div id="review-request-fields" class="contact ethossence-form cart-attributes">

  <!-- Add this to your Shopify template -->
   <div id="dynamic-content-container">
      <div class="loading-spinner">Loading...</div>
   </div>

   <script>
      (function() {
      const MAKE_WEBHOOK_URL = 'https://hook.us2.make.com/qlomn3r4q8lhetra9irfer8o611xppav';
      
      async function loadDynamicContent() {
         const container = document.getElementById('dynamic-content-container');
         
         try {
            // Get cart data using Shopify Ajax API
            const cartResponse = await fetch('/cart.js');
            const cartData = await cartResponse.json();
            
            // Transform cart attributes into array of objects
            const formattedAttributes = [];
            
            if (cartData.attributes) {
            for (const [name, value] of Object.entries(cartData.attributes)) {
               formattedAttributes.push({
                  name: name,
                  value: value
               });
            }
            }
            
            // Send formatted data to Make
            const requestData = {
            pageUrl: window.location.href,
            shopDomain: Shopify.shop || '',
            customerId: window.ShopifyAnalytics?.meta?.customerId || null,
            timestamp: new Date().toISOString(),
            // Send both formats - choose what works best
            cart: {
               // Original format (if you still need it)
               attributes: cartData.attributes || {},
               // New formatted array
               formattedAttributes: formattedAttributes,
               // Other cart data
               itemCount: cartData.item_count,
               totalPrice: cartData.total_price,
            }
            };
            
            // Fetch HTML from Make webhook
            const response = await fetch(MAKE_WEBHOOK_URL, {
            method: 'POST',
            headers: {
               'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
            });
            
            if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            // Get HTML content
            const htmlContent = await response.text();
            
            // Insert HTML into container
            container.innerHTML = htmlContent;
            
         } catch (error) {
            console.error('Error loading dynamic content:', error);
            container.innerHTML = '<div class="error-message">Failed to load content. Please try again later.</div>';
         }
      }
      
      // Load content when DOM is ready
      if (document.readyState === 'loading') {
         document.addEventListener('DOMContentLoaded', loadDynamicContent);
      } else {
         loadDynamicContent();
      }
      })();
   </script>

   <div class="cart-save-draft" style="margin: 2rem 0; text-align: center;">
      <button id="save-cart-draft" type="button" class="button" data-customer-id="{{ customer.id }}" data-customer-email="{{ customer.email }}">
         {{ bth_submit_account |  default: 'Submit for Review' }}
      </button>
      <div id="save-cart-message" style="margin-top: 1rem; display: none;"></div>
   </div>

</div>