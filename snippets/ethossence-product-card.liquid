{% comment %}
  Renders a product card for collection bundle section

  Accepts:
  - product: {Object} Product Liquid object
  - section: {Object} Section Liquid object
  - card_class: {String} Additional CSS class for the card
  - quick_add: {String} Quick add type: 'none', 'standard', or 'bulk'

  Usage:
  {% render 'ethossence-product-card', product: product, section: section, quick_add: 'standard' %}
{% endcomment %}

{%- if product and product != blank -%}
  {%- liquid
    assign ratio = 1
    if product.featured_media
      assign ratio = product.featured_media.aspect_ratio
    endif
    if ratio == 0 or ratio == null
      assign ratio = 1
    endif

    assign section_id = section.id
    assign product_form_id = 'bundle-quick-add-' | append: section_id | append: '-' | append: product.id
  -%}

  <div class="collection-bundle-product {{ card_class }}">
    <div class="bundle-product-inner">

      {%- if product.featured_media -%}
        <div class="bundle-product-media">
          <a href="{{ product.url }}" class="bundle-product-link" id="BundleCardLink-{{ section_id }}-{{ product.id }}">
            <div class="media media--transparent">
              <img
                srcset="
                  {%- if product.featured_media.width >= 165 -%}{{ product.featured_media | image_url: width: 165 }} 165w,{%- endif -%}
                  {%- if product.featured_media.width >= 360 -%}{{ product.featured_media | image_url: width: 360 }} 360w,{%- endif -%}
                  {%- if product.featured_media.width >= 533 -%}{{ product.featured_media | image_url: width: 533 }} 533w,{%- endif -%}
                  {%- if product.featured_media.width >= 720 -%}{{ product.featured_media | image_url: width: 720 }} 720w,{%- endif -%}
                  {{ product.featured_media | image_url }} {{ product.featured_media.width }}w
                "
                src="{{ product.featured_media | image_url: width: 533 }}"
                sizes="(min-width: 990px) calc(50vw - 10rem), calc(100vw - 3rem)"
                alt="{{ product.featured_media.alt | escape }}"
                loading="lazy"
                width="{{ product.featured_media.width }}"
                height="{{ product.featured_media.height }}"
              >
            </div>
          </a>

          {%- if product.available == false -%}
            <div class="card__badge">
              <span class="badge badge--bottom-left color-{{ settings.sold_out_badge_color_scheme }}">
                {{- 'products.product.sold_out' | t -}}
              </span>
            </div>
          {%- elsif product.compare_at_price > product.price and product.available -%}
            <div class="card__badge">
              <span class="badge badge--bottom-left color-{{ settings.sale_badge_color_scheme }}">
                {{- 'products.product.on_sale' | t -}}
              </span>
            </div>
          {%- endif -%}
        </div>
      {%- endif -%}

      <div class="bundle-product-info">
        <h3 class="bundle-product-title h3" id="bundle-title-{{ section_id }}-{{ product.id }}">
          <a href="{{ product.url }}">{{ product.title | escape }}</a>
        </h3>

        {%- if product.vendor != blank -%}
          <div class="bundle-product-vendor caption-with-letter-spacing">
            {{ product.vendor }}
          </div>
        {%- endif -%}

        <div class="bundle-product-price">
          {% render 'price', product: product, use_variant: true, show_badges: false %}

          {%- if product.quantity_price_breaks_configured? -%}
            {% if product.variants_count == 1 and quick_add == 'bulk' %}
              {% liquid
                assign quantity_rule = product.selected_or_first_available_variant.quantity_rule
                assign has_qty_rules = false
                if quantity_rule.increment > 1 or quantity_rule.min > 1 or quantity_rule.max != null
                  assign has_qty_rules = true
                endif
              %}
              <quantity-popover>
                <button class="card__information-volume-pricing-note card__information-volume-pricing-note--button quantity-popover__info-button--icon-only button button--tertiary medium-hide small-hide">
                  <span class="caption">{{ 'products.product.volume_pricing.note' | t }}</span>
                </button>
                <button class="card__information-volume-pricing-note card__information-volume-pricing-note--button quantity-popover__info-button--icon-with-label button button--tertiary large-up-hide">
                  <span class="caption">{{ 'products.product.volume_pricing.note' | t }}</span>
                </button>
            {% else %}
              <div class="card__information-volume-pricing-note">
                <span class="caption">{{ 'products.product.volume_pricing.note' | t }}</span>
              </div>
            {% endif %}
            {% if product.variants_count == 1 and quick_add == 'bulk' %}
              <div
                class="global-settings-popup quantity-popover__info"
                tabindex="-1"
                hidden
                id="quantity-popover-info-{{ product.selected_or_first_available_variant.id }}"
              >
                {%- if has_qty_rules -%}
                  <div class="quantity__rules caption no-js-hidden">
                    {%- if quantity_rule.increment > 1 -%}
                      <span class="divider">
                        {{- 'products.product.quantity.multiples_of' | t: quantity: quantity_rule.increment -}}
                      </span>
                    {%- endif -%}
                    {%- if quantity_rule.min > 1 -%}
                      <span class="divider">
                        {{- 'products.product.quantity.min_of' | t: quantity: quantity_rule.min -}}
                      </span>
                    {%- endif -%}
                    {%- if quantity_rule.max != null -%}
                      <span class="divider">
                        {{- 'products.product.quantity.max_of' | t: quantity: quantity_rule.max -}}
                      </span>
                    {%- endif -%}
                  </div>
                {%- endif -%}
                <button
                  class="button-close button button--tertiary large-up-hide"
                  type="button"
                  aria-label="{{ 'accessibility.close' | t }}"
                >
                  {{- 'icon-close.svg' | inline_asset_content -}}
                </button>
                {%- if product.selected_or_first_available_variant.quantity_price_breaks.size > 0 -%}
                  <volume-pricing class="parent-display">
                    <ul class="list-unstyled">
                      <li>
                        <span>{{ product.selected_or_first_available_variant.quantity_rule.min }}+</span>
                        {%- assign price = product.selected_or_first_available_variant.price | money_with_currency -%}
                        <span>{{ 'sections.quick_order_list.each' | t: money: price }}</span>
                      </li>
                      {%- for price_break in product.selected_or_first_available_variant.quantity_price_breaks -%}
                        <li>
                          <span>
                            {{- price_break.minimum_quantity -}}
                            <span aria-hidden="true">+</span></span
                          >
                          {%- assign price = price_break.price | money_with_currency -%}
                          <span> {{ 'sections.quick_order_list.each' | t: money: price }}</span>
                        </li>
                      {%- endfor -%}
                    </ul>
                  </volume-pricing>
                {%- endif -%}
              </div>
              </quantity-popover>
            {% endif %}
          {%- endif -%}
        </div>

        {%- if product.description != blank -%}
          <div class="bundle-product-description rte">
            {{ product.description | strip_html | truncate: 150 }}
          </div>
        {%- endif -%}

        <div class="bundle-product-cta">
          {% if quick_add == 'standard' %}
            <div class="quick-add no-js-hidden">
              {%- liquid
                assign qty_rules = false
                if product.selected_or_first_available_variant.quantity_rule.min > 1 or product.selected_or_first_available_variant.quantity_rule.max != null or product.selected_or_first_available_variant.quantity_rule.increment > 1
                  assign qty_rules = true
                endif
              -%}
              {%- if product.variants_count > 1 or qty_rules -%}
                <modal-opener data-modal="#QuickAdd-{{ product.id }}-{{ section_id }}">
                  <button
                    id="{{ product_form_id }}-submit"
                    type="submit"
                    name="add"
                    class="quick-add__submit button button--full-width button--secondary"
                    aria-haspopup="dialog"
                    aria-labelledby="{{ product_form_id }}-submit bundle-title-{{ section_id }}-{{ product.id }}"
                    data-product-url="{{ product.url }}"
                  >
                    {{ 'products.product.choose_options' | t }}
                    {%- render 'loading-spinner' -%}
                  </button>
                </modal-opener>
                <quick-add-modal id="QuickAdd-{{ product.id }}-{{ section_id }}" class="quick-add-modal">
                  <div
                    role="dialog"
                    aria-label="{{ 'products.product.choose_product_options' | t: product_name: product.title | escape }}"
                    aria-modal="true"
                    class="quick-add-modal__content global-settings-popup"
                    tabindex="-1"
                  >
                    <button
                      id="ModalClose-{{ product.id }}-{{ section_id }}"
                      type="button"
                      class="quick-add-modal__toggle"
                      aria-label="{{ 'accessibility.close' | t }}"
                    >
                      {{- 'icon-close.svg' | inline_asset_content -}}
                    </button>
                    <div id="QuickAddInfo-{{ product.id }}-{{ section_id }}" class="quick-add-modal__content-info"></div>
                  </div>
                </quick-add-modal>
              {%- else -%}
                <product-form data-section-id="{{ section.id }}">
                  {%- form 'product',
                    product,
                    id: product_form_id,
                    class: 'form',
                    novalidate: 'novalidate',
                    data-type: 'add-to-cart-form'
                  -%}
                    <input
                      type="hidden"
                      name="id"
                      value="{{ product.selected_or_first_available_variant.id }}"
                      class="product-variant-id"
                      {% if product.selected_or_first_available_variant.available == false %}
                        disabled
                      {% endif %}
                    >
                    <button
                      id="{{ product_form_id }}-submit"
                      type="submit"
                      name="add"
                      class="quick-add__submit button button--full-width button--secondary"
                      aria-haspopup="dialog"
                      aria-labelledby="{{ product_form_id }}-submit bundle-title-{{ section_id }}-{{ product.id }}"
                      aria-live="polite"
                      data-sold-out-message="true"
                      {% if product.selected_or_first_available_variant.available == false %}
                        disabled
                      {% endif %}
                    >
                      <span>
                        {%- if product.selected_or_first_available_variant.available -%}
                          {{ 'products.product.add_to_cart' | t }}
                        {%- else -%}
                          {{ 'products.product.sold_out' | t }}
                        {%- endif -%}
                      </span>
                      <span class="sold-out-message hidden">
                        {{ 'products.product.sold_out' | t }}
                      </span>
                      {%- render 'loading-spinner' -%}
                    </button>
                  {%- endform -%}
                </product-form>
              {%- endif -%}
            </div>
          {% elsif quick_add == 'bulk' %}
            {% if product.variants_count == 1 %}
              <quick-add-bulk
                data-min="{{ product.selected_or_first_available_variant.quantity_rule.min }}"
                id="quick-add-bulk-{{ product.selected_or_first_available_variant.id }}-{{ section.id }}"
                class="quick-add-bulk"
                data-index="{{ product.selected_or_first_available_variant.id }}"
              >
                {% if product.selected_or_first_available_variant.available == false %}
                  <button
                    id="{{ product_form_id }}-submit"
                    type="submit"
                    name="add"
                    class="quick-add__submit button button--full-width button--secondary"
                    aria-labelledby="{{ product_form_id }}-submit bundle-title-{{ section_id }}-{{ product.id }}"
                    data-sold-out-message="true"
                    disabled
                  >
                    <span>{{ 'products.product.sold_out' | t }}</span>
                    <span class="sold-out-message hidden">
                      {{ 'products.product.sold_out' | t }}
                    </span>
                  </button>
                {% else %}
                  {% render 'quantity-input', variant: product.selected_or_first_available_variant, min: 0 %}
                {% endif %}
              </quick-add-bulk>
            {% else %}
              <div class="quick-add no-js-hidden">
                {%- liquid
                  assign qty_rules = false
                  if product.selected_or_first_available_variant.quantity_rule.min > 1 or product.selected_or_first_available_variant.quantity_rule.max != null or product.selected_or_first_available_variant.quantity_rule.increment > 1
                    assign qty_rules = true
                  endif
                -%}
                <modal-opener
                  id="QuickBulk-{{ product.id }}-{{ section_id }}"
                  data-modal="#QuickAddBulk-{{ product.id }}-{{ section.id }}"
                >
                  <button
                    id="{{ product_form_id }}-submit"
                    type="submit"
                    name="add"
                    class="quick-add__submit button button--full-width button--secondary"
                    aria-haspopup="dialog"
                    aria-labelledby="{{ product_form_id }}-submit bundle-title-{{ section_id }}-{{ product.id }}"
                    data-product-url="{{ product.url }}"
                  >
                    {{ 'products.product.choose_options' | t }}
                    {%- render 'loading-spinner' -%}
                  </button>
                </modal-opener>
                <modal-dialog
                  id="QuickAddBulk-{{ product.id }}-{{ section_id }}"
                  class="quick-add-modal color-{{ section.settings.color_scheme }}"
                >
                  <div
                    role="dialog"
                    aria-label="{{ 'products.product.choose_product_options' | t: product_name: product.title | escape }}"
                    aria-modal="true"
                    class="quick-add-modal__content quick-add-modal__content--bulk global-settings-popup"
                    tabindex="-1"
                  >
                    <button
                      id="ModalClose-{{ product.id }}-{{ section_id }}"
                      type="button"
                      class="quick-add-modal__toggle"
                      aria-label="{{ 'accessibility.close' | t }}"
                    >
                      {{- 'icon-close.svg' | inline_asset_content -}}
                    </button>
                    <div
                      id="QuickAddInfo-{{ product.id }}-{{ section_id }}"
                      class="quick-add-modal__content-info quick-add-modal__content-info--bulk"
                    ></div>
                  </div>
                </modal-dialog>
              </div>
            {% endif %}
          {% else %}
            {%- comment -%} No quick add - show View Product button {%- endcomment -%}
            <a href="{{ product.url }}" class="button button--primary button--full-width">
              View Product
            </a>
          {% endif %}
        </div>
      </div>

    </div>
  </div>
{%- endif -%}
