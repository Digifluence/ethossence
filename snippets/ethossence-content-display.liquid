{%- comment -%}
  ETHOSSENCE CONTENT DISPLAY SNIPPET

  Processes page/article content to support multi-column layout using [[ COL X/6 ]] markers.
  Converts content into a grid-based layout system.

  Parameters:
  - content: The page.content or article.content to process
  - img_hero: Optional hero image URL
  - img_hero_class: Optional CSS class for hero image

  Returns (outputs):
  - Processed HTML content with grid structure

  Usage:
  {% render 'ethossence-content-display',
    content: page.content,
    img_hero: page.metafields.ethossence.img_hero,
    img_hero_class: img_hero_class
  %}

  {% render 'ethossence-content-display',
    content: article.content
  %}
{%- endcomment -%}

{%- liquid
  if content != blank

    comment
      ETHOSSENCE PROCESS TO ALLOW MULTIPLE COLUMNS IN PAGE CONTENT
    endcomment

    comment
      Clean up <p> tags around column markers and extra whitespace
    endcomment
    assign content = content | replace: '<p>[[ COL ', '[[ COL '
    assign content = content | replace: ' ]]</p>', ' ]]'
    assign content = content | replace: ' ]]<br></p>', ' ]]'
    assign content = content | replace: '<p> </p>', ''

    comment
      Split content by column markers
    endcomment
    assign content_sections = content | split: '[[ COL '

    comment
      Start output with grid wrapper
    endcomment
    assign output = '<div class="content-grid grid grid--6-col">'

    comment
      Track if we're in the first section and row column count
    endcomment
    assign first_section = true
    assign current_row_cols = 0
    assign errors = ''

    for content_section in content_sections

      if first_section

          comment
            Content before first column marker
          endcomment

          assign first_section = false
          assign trimmed = content_section | strip

        if trimmed != ''
          assign output = output | append: '<div class="grid__item grid__item--6-col">'
          assign output = output | append: content_section
          assign output = output | append: '</div>'
        endif

      else

        comment
          Process column marker and content
        endcomment

        assign parts = content_section | split: ' ]]'
        assign col_definition = parts[0]

        comment
          Get everything after the marker
        endcomment
        assign parts_size = parts | size
        assign remaining_content = ''

        for part in parts offset: 1
          if forloop.first
            assign remaining_content = part
          else
            assign remaining_content = remaining_content | append: ' ]]' | append: part
          endif
        endfor

        comment
          Parse column size and validate
        endcomment
        assign col_parts = col_definition | split: '/'
        assign col_size_str = col_parts[0] | strip
        assign col_size = col_size_str | times: 1

        comment
          Validate column size
        endcomment
        assign is_valid = false

        if col_size_str == '1' or col_size_str == '2' or col_size_str == '3' or col_size_str == '4' or col_size_str == '5' or col_size_str == '6'
          if col_size >= 1 and col_size <= 6
            assign is_valid = true
          endif
        endif

        comment
          Track column count for row validation
        endcomment
        assign new_row_total = current_row_cols | plus: col_size

        if new_row_total > 6
          comment
            Reset to new row
          endcomment
          assign current_row_cols = col_size
        else
          assign current_row_cols = new_row_total
        endif

        comment
          Clean up remaining content
        endcomment
        assign remaining_content = remaining_content | replace: '<p></p>', ''

        comment
          Only add column if valid and has content
        endcomment
        assign trimmed_content = remaining_content | strip

        if is_valid and trimmed_content != ''
          assign col_class = 'grid__item grid__item--' | append: col_size | append: '-col'
          assign output = output | append: '<div class="' | append: col_class | append: '">'
          assign output = output | append: remaining_content
          assign output = output | append: '</div>'
        elsif is_valid == false
          comment
            Log error for invalid column size
          endcomment
          assign error_msg = '<div class="content-grid-error">Invalid column size: [[ COL ' | append: col_definition | append: ' ]] - must be 1-6</div>'
          assign output = output | append: error_msg
        endif

      endif

    endfor

    comment
      Close grid wrapper
    endcomment
    assign output = output | append: '</div>'


    if output contains 'BUTTON:'
      assign output = output | replace: '<a', '<a class="button"' | remove: 'BUTTON:'
    endif

    comment
      Final cleanup of any remaining empty paragraphs
    endcomment
    assign output = output | replace: '<p></p>', ''
    assign output = output | replace: '<p> </p>', ''

  endif
-%}

{%- comment -%} Output the processed content {%- endcomment -%}
{%- if output != blank -%}
  {%- if img_hero != blank -%}
    {{ img_hero | image_url: width: 600 | image_tag: loading: 'lazy', class: img_hero_class }}
  {%- endif -%}
  {{ output }}
{%- else -%}
  <div class="page-placeholder-wrapper placeholder">
    {{ 'page' | placeholder_svg_tag: 'page-placeholder' }}
  </div>
{%- endif -%}
